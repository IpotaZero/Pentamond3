class h{static eventList=[];static get ids(){return this.eventList.map(({id:e})=>e)}static addEvent({id:e,handler:t,classNames:s=[]}){if(e)return this.ids.includes(e)?console.error("idが重複しているため、このEventは登録に失敗しました"):this.eventList.push({id:e,handler:t,classNames:s}),e;for(e=Date.now();this.ids.includes(e);)e++;return this.eventList.push({id:e,handler:t,classNames:s}),e}static removeEvent(e){this.eventList=this.eventList.filter(({id:t})=>t!=e)}static removeEvents(e){this.eventList=this.eventList.filter(({id:t})=>!e.includes(t))}static removeEventsByClassName(e){this.eventList=this.eventList.filter(({classNames:t})=>!t.includes(e))}static notExists(e){return this.ids.includes(e)?!1:(console.error("指定されたidのEventは登録されていません"),!0)}static executeEvent(e){this.notExists(e)||this.eventList.filter(({id:t})=>t==e)[0].handler()}static executeEventsByClassName(e){this.eventList.filter(({classNames:t})=>t.includes(e)).forEach(({handler:t})=>{t()})}static executeListeningEvents(e,t){this.eventList.filter(({id:s,classNames:i})=>t.includes(s)&&i.includes(e)).forEach(({handler:s})=>{s()})}static consoleEventClasses(){console.log(this.eventList.map(({classNames:e})=>e))}}class ee{initialized=!1;currentPage=null;displayingPages=[];pageMemory=[];static instance;eventClassNames=["pageIsReady","pageOpened","pageChanged","setPage","backPages","pageBecomeValid","pageBecomeInvalid","setSubPage"];addEvent(e,t){return h.addEvent({classNames:e,handler:t})}constructor(){if(ee.instance)return ee.instance;ee.instance=this}get g$initialized(){return this.initialized}get g$currentPage(){return this.currentPage}get g$currentPageId(){return this.currentPage?this.currentPage.id:""}init(){if(this.initialized)return;const e=document.body.dataset.initialPage||"title";this.setPage(e),this.initialized=!0,h.executeEventsByClassName("pageIsReady")}setPages(e,t){if(!e.length)return;const s=e.map(n=>document.getElementById(n)||null);if(s.includes(null))return;const i=s.map(n=>this.getLayer(n)),a=Math.max(...i);i.filter(n=>n===a).length==1&&(this.displayingPages.forEach(n=>{n.style.display="none"}),s.forEach(n=>{n.style.display="flex"}),this.currentPage=s[i.findIndex(n=>n==a)],this.displayingPages=s,this.pageMemory.push(e),this.setSubPage(0,{eventIgnore:!0}),t&&t.eventIgnore||(h.executeEventsByClassName("pageChanged"),h.executeEventsByClassName("pageChanged-"+(this.currentPage?this.currentPage.id:""))))}setPage(e,t){const s=document.getElementById(e);if(!s){console.error("指定されたpageIdのページは存在しません:"+e);return}let i=this.displayingPages.map(a=>a.id);if(this.currentPage){const a=this.getLayer(this.currentPage),n=this.getLayer(s);if(n==a)i=i.filter(r=>r!=this.currentPage.id);else if(n<a)throw new Error(`現在のlayerを下回るlayerのページには遷移できません:${this.currentPage.id}から${e}`)}i.push(s.id),this.setPages(i,t),t&&t.eventIgnore||(h.executeEventsByClassName("setPage"),h.executeEventsByClassName("setPage-"+e),h.executeEventsByClassName("pageOpened"),h.executeEventsByClassName("pageOpened-"+e))}backPages(e,t){if(e==-1&&(e=this.pageMemory.length-1),this.pageMemory.length<e+1||e<-1){console.log(`ページ遷移の記録がないため戻ることはできません:${this.g$currentPageId}から${e}ページ前`);return}const s=this.getLayer(this.currentPage)||0;this.setPages(this.pageMemory[this.pageMemory.length-e-1],t),this.pageMemory=this.pageMemory.slice(0,-e-1),t&&t.eventIgnore||(s==(this.getLayer(this.currentPage)||0)&&(h.executeEventsByClassName("pageOpened"),h.executeEventsByClassName("pageOpened-"+this.currentPage.id)),h.executeEventsByClassName("backPages"))}set s$valid(e){this.displayingPages.forEach(s=>{s.style.display=e?"flex":"none"});const t=document.getElementById("invalidPanel");t&&(t.style.display=e?"none":"flex"),h.executeEventsByClassName(e?"pageBecomeValid":"pageBecomeInvalid")}getLatestBackIndex(e){const t=this.pageMemory.length-1-this.pageMemory.findLastIndex(s=>s.includes(e));return t==this.pageMemory.length?-1:t}backLatestPage(e,t){const s=this.getLatestBackIndex(e);s!=-1&&this.backPages(s,t)}setSubPage(e,t){if(!this.currentPage||!this.currentPage.querySelector(".subPage"))return;const s=Array.from(this.currentPage.querySelectorAll(".subPage")),i=this.currentPage.querySelector(".subPageLabel"),a=(s.length+e)%s.length;s.forEach((n,r)=>{r==a?(n.style.display="",i&&(i.innerHTML=`${a+1} / ${s.length}`)):n.style.display="none"}),t&&t.eventIgnore||h.executeEventsByClassName("setSubPage")}getLayer(e){return e?parseInt(e.dataset.layer||"0"):null}}const p=new ee;function Z(o){return new Promise(e=>{setTimeout(e,o)})}function ye(o){const e=o.length*Math.log(o.length)/2;let t,s,i,a;for(let n=0;n<e;n++)i=Math.floor(Math.random()*o.length),a=Math.floor(Math.random()*o.length),t=o[i],s=o[a],o[i]=s,o[a]=t}function P(o){return Array.from(document.querySelectorAll(o))}function T(o){return document.querySelector(o)}function I(o,e,t){P(o).forEach(s=>{s.addEventListener(e,()=>{t(s)})})}function Y(o,e){return o.length<=e.length?o.map((t,s)=>t+e[s]):e.map((t,s)=>t+o[s])}function Pe(o){if(o.length==0)return null;let e=1/0,t=null;return o.forEach(({element:s,value:i})=>{i<e&&(e=i,t=s)}),t}function $e(){document.body.style.cursor!="none"&&(document.body.style.cursor="none",window.addEventListener("mousemove",()=>{document.body.style.cursor=""},{once:!0}))}class _e{startTime=null;lastPauseTime=null;pauseSpan=0;hasStarted=!1;isPausing=!1;constructor(e=!1){e&&this.start()}get g$startTime(){return this.startTime}get g$lastPauseTime(){return this.lastPauseTime}get g$hasStarted(){return this.hasStarted}get g$isPausing(){return this.isPausing}get g$pauseSpan(){return this.pauseSpan}start(){this.hasStarted||(this.startTime=Date.now(),this.hasStarted=!0,this.isPausing=!1)}pause(){!this.hasStarted||this.isPausing||(this.lastPauseTime=Date.now(),this.isPausing=!0)}resume(){!this.hasStarted||!this.isPausing||(this.pauseSpan+=Date.now()-this.lastPauseTime,this.isPausing=!1)}reset(e=!1){this.startTime=null,this.lastPauseTime=null,this.pauseSpan=0,this.hasStarted=!1,this.isPausing=!1,e&&this.start()}get g$elapsedTime(){return this.hasStarted?this.isPausing?this.lastPauseTime-this.pauseSpan-this.startTime:Date.now()-this.pauseSpan-this.startTime:null}getGoalCount(e){return this.hasStarted?Math.floor(this.g$elapsedTime/e):0}}class le{loopFrequency=0;loopTimer=null;loopCount=0;loopId=null;isLooping=!1;speedMagnification=1;eventClassNames=["loop"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(e=!1){e&&this.start()}get g$isLooping(){return this.isLooping}get g$loopFrequency(){return this.loopFrequency}get g$loopCount(){return this.loopCount}get g$speedMagnification(){return this.speedMagnification}set s$loopFrequency(e){if(Number.isNaN(e)||!Number.isFinite(e)||e<=0)throw new Error("不正な値が入力されました: "+e);this.loopFrequency=e}set s$speedMagnification(e){if(Number.isNaN(e)||!Number.isFinite(e)||e<=0)throw new Error("不正な値が入力されました: "+e);if(this.isLooping){console.error("ループ中にはスピード倍率を変更できません");return}this.speedMagnification=e}start(){this.isLooping||(this.loopId=requestAnimationFrame(this.loop.bind(this)),this.loopTimer?this.loopTimer.resume():this.loopTimer=new _e(!0),this.isLooping=!0)}stop(){this.loopTimer&&this.loopTimer.pause(),this.loopId&&cancelAnimationFrame(this.loopId),this.isLooping=!1}reset(){this.stop(),this.loopTimer&&(this.loopTimer.reset(),this.loopTimer=null),this.loopCount=0}loop(){if(!this.loopTimer)return;if(!this.isLooping){this.stop();return}const e=this.loopTimer.getGoalCount(this.loopFrequency);if(this.loopCount!=e)if(e==1/0)h.executeListeningEvents("loop",this.eventIds),this.loopCount++;else for(;this.loopCount<e;)h.executeListeningEvents("loop",this.eventIds),this.loopCount++;this.loopId=requestAnimationFrame(this.loop.bind(this))}get g$elapsedTime(){return this.loopTimer?this.loopTimer.g$elapsedTime*this.speedMagnification:0}getGoalCount(e){return this.loopTimer?Math.floor(this.g$elapsedTime*this.speedMagnification/e):0}}class Se{loop=new le;inputData=[];inputDataTask=[];pressingKeys=[];pressTimes=[];valid=!1;eventClassNames=["onKeydown","onKeyup"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(){}get g$isValid(){return this.valid}get g$latestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[this.pressingKeys.length-1]:""}get g$oldestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[0]:""}get g$latestPressTime(){return this.pressTimes.length!=0?this.pressTimes[this.pressTimes.length-1]:-1}get g$oldestPressTime(){return this.pressTimes.length!=0?this.pressTimes[0]:-1}get g$inputData(){return this.inputData}set s$inputData(e){if(this.loop.g$isLooping)return;this.inputData=e,this.inputDataTask=window.structuredClone(e);const t=i=>{this.pressingKeys.includes(i)||(this.pressingKeys.push(i),this.pressTimes.push(Date.now()),h.executeListeningEvents("onKeydown",this.eventIds))},s=i=>{this.pressingKeys=this.pressingKeys.filter((a,n)=>(a==i&&(this.pressTimes[n]=-1),a!=i)),this.pressTimes=this.pressTimes.filter(a=>a!=-1),h.executeListeningEvents("onKeyup",this.eventIds)};h.removeEvents(this.loop.eventIds),this.loop.addEvent(["loop"],()=>{for(;;)if(this.inputDataTask.length)if(this.inputDataTask[0].time<=this.loop.g$elapsedTime)["keydown","downup"].includes(this.inputDataTask[0].type)&&t(this.inputDataTask[0].keyCode),["keyup","downup"].includes(this.inputDataTask[0].type)&&s(this.inputDataTask[0].keyCode),this.inputDataTask.shift();else break;else{this.loop.stop();return}})}start(){this.loop.g$elapsedTime&&this.inputDataTask.length&&this.loop.start(),this.valid=!0}stop(){this.valid=!1,this.loop.stop(),this.pressingKeys=[],this.pressTimes=[]}playStart(){this.inputDataTask.length&&this.loop.start()}playReset(){this.loop.reset(),this.s$inputData=this.inputData}isPressing(e){return this.pressingKeys.includes(e)}arePressing(e){let t=!0;return e.forEach(s=>{t=t&&this.isPressing(s)}),t}existsPressingKey(e){let t=!1;return e.forEach(s=>{t=t||this.isPressing(s)}),t}getPressTime(e){return this.pressingKeys.indexOf(e)==-1?-1:this.pressTimes[this.pressingKeys.indexOf(e)]}getLatestPressingKey(e){let t=-1;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);t<i&&(t=i)}),t==-1?"":this.pressingKeys[t]}getOldestPressingKey(e){let t=1/0;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);i<t&&i!=-1&&(t=i)}),t==-1?"":this.pressingKeys[t]}getAllPressingKeys(e){return this.pressingKeys.filter(t=>e.includes(t))}}class et{index;axisThreshold;loop=new le;lastButtons=[];lastAxesInfo=[];onButtonDown=null;onButtonUp=null;onAxisActive=null;onAxisInactive=null;constructor(e,t=.4){this.index=e,this.axisThreshold=t;const s=()=>{const i=navigator.getGamepads()[this.index];i&&this.processGamepad(i)};this.loop.addEvent(["loop"],s.bind(this))}get g$connecting(){return navigator.getGamepads()[this.index]!=null}start(){this.loop.start()}processGamepad(e){e.buttons.forEach((t,s)=>{const i=t.pressed,a=this.lastButtons[s]??!1;i!==a&&(i?this.onButtonDown?.({gamepadIndex:this.index,buttonIndex:s,pressed:!0}):this.onButtonUp?.({gamepadIndex:this.index,buttonIndex:s,pressed:!1})),this.lastButtons[s]=i}),e.axes.forEach((t,s)=>{const i=Math.abs(t)>=this.axisThreshold,a=this.lastAxesInfo[s]?this.lastAxesInfo[s].active:!1;i!==a?i?this.onAxisActive?.({gamepadIndex:this.index,axisIndex:s,value:t,active:!0}):this.onAxisInactive?.({gamepadIndex:this.index,axisIndex:s,value:this.lastAxesInfo[s].value??0,active:!1}):(this.lastAxesInfo[s]?this.lastAxesInfo[s].value:0)*t<0&&(a&&this.onAxisInactive?.({gamepadIndex:this.index,axisIndex:s,value:this.lastAxesInfo[s].value??0,active:!1}),i&&this.onAxisActive?.({gamepadIndex:this.index,axisIndex:s,value:t,active:!0})),this.lastAxesInfo[s]={gamepadIndex:this.index,axisIndex:s,value:t,active:i}})}stop(){this.loop.stop()}}class tt{input;pressingKeys=[];pressTimes=[];valid=!1;eventClassNames=["onButtondown","onButtonup","onStickActive","onStickInactive"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(e){this.input=new et(e),this.input.onButtonDown=t=>{this.pressingKeys.includes("button:"+t.buttonIndex)||(this.pressingKeys.push("button:"+t.buttonIndex),this.pressTimes.push(Date.now()),h.executeListeningEvents("onButtondown",this.eventIds))},this.input.onButtonUp=t=>{this.pressingKeys=this.pressingKeys.filter((s,i)=>(s=="button:"+t.buttonIndex&&(this.pressTimes[i]=-1),s!="button:"+t.buttonIndex)),this.pressTimes=this.pressTimes.filter(s=>s!=-1),h.executeListeningEvents("onButtonup",this.eventIds)},this.input.onAxisActive=t=>{t.value>0?this.pressingKeys.includes("stick:+"+t.axisIndex)||(this.pressingKeys.push("stick:+"+t.axisIndex),this.pressTimes.push(Date.now()),h.executeListeningEvents("onStickActive",this.eventIds)):this.pressingKeys.includes("stick:-"+t.axisIndex)||(this.pressingKeys.push("stick:-"+t.axisIndex),this.pressTimes.push(Date.now()),h.executeListeningEvents("onStickActive",this.eventIds))},this.input.onAxisInactive=t=>{t.value>0?(this.pressingKeys=this.pressingKeys.filter((s,i)=>(s=="stick:+"+t.axisIndex&&(this.pressTimes[i]=-1),s!="stick:+"+t.axisIndex)),this.pressTimes=this.pressTimes.filter(s=>s!=-1),h.executeListeningEvents("onStickInactive",this.eventIds)):(this.pressingKeys=this.pressingKeys.filter((s,i)=>(s=="stick:-"+t.axisIndex&&(this.pressTimes[i]=-1),s!="stick:-"+t.axisIndex)),this.pressTimes=this.pressTimes.filter(s=>s!=-1),h.executeListeningEvents("onStickInactive",this.eventIds))}}get g$isValid(){return this.valid}get g$latestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[this.pressingKeys.length-1]:""}get g$oldestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[0]:""}get g$latestPressTime(){return this.pressTimes.length!=0?this.pressTimes[this.pressTimes.length-1]:-1}get g$oldestPressTime(){return this.pressTimes.length!=0?this.pressTimes[0]:-1}start(){this.valid||(this.input.start(),this.valid=!0)}stop(){this.valid&&(this.valid=!1,this.input.stop(),this.pressingKeys=[],this.pressTimes=[])}isPressing(e){return this.pressingKeys.includes(e)}arePressing(e){let t=!0;return e.forEach(s=>{t=t&&this.isPressing(s)}),t}existsPressingKey(e){let t=!1;return e.forEach(s=>{t=t||this.isPressing(s)}),t}getPressTime(e){return this.pressingKeys.indexOf(e)==-1?-1:this.pressTimes[this.pressingKeys.indexOf(e)]}getLatestPressingKey(e){let t=-1;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);t<i&&(t=i)}),t==-1?"":this.pressingKeys[t]}getOldestPressingKey(e){let t=1/0;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);i<t&&i!=-1&&(t=i)}),t==-1?"":this.pressingKeys[t]}getAllPressingKeys(e){return this.pressingKeys.filter(t=>e.includes(t))}}class Ce{pressingKeys=[];pressTimes=[];valid=!1;keydownEvent;keyupEvent;eventClassNames=["onKeydown","onKeyup"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(){this.keydownEvent=e=>{this.pressingKeys.includes(e.code)||(this.pressingKeys.push(e.code),this.pressTimes.push(Date.now()),h.executeListeningEvents("onKeydown",this.eventIds))},this.keyupEvent=e=>{this.pressingKeys=this.pressingKeys.filter((t,s)=>(t==e.code&&(this.pressTimes[s]=-1),t!=e.code)),this.pressTimes=this.pressTimes.filter(t=>t!=-1),h.executeListeningEvents("onKeyup",this.eventIds)}}get g$isValid(){return this.valid}get g$latestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[this.pressingKeys.length-1]:""}get g$oldestPressingKey(){return this.pressingKeys.length!=0?this.pressingKeys[0]:""}get g$latestPressTime(){return this.pressTimes.length!=0?this.pressTimes[this.pressTimes.length-1]:-1}get g$oldestPressTime(){return this.pressTimes.length!=0?this.pressTimes[0]:-1}start(){this.valid||(document.addEventListener("keydown",this.keydownEvent),document.addEventListener("keyup",this.keyupEvent),this.valid=!0)}stop(){this.valid&&(this.valid=!1,document.removeEventListener("keydown",this.keydownEvent),document.removeEventListener("keyup",this.keyupEvent),this.pressingKeys=[],this.pressTimes=[])}isPressing(e){return this.pressingKeys.includes(e)}arePressing(e){let t=!0;return e.forEach(s=>{t=t&&this.isPressing(s)}),t}existsPressingKey(e){let t=!1;return e.forEach(s=>{t=t||this.isPressing(s)}),t}getPressTime(e){return this.pressingKeys.indexOf(e)==-1?-1:this.pressTimes[this.pressingKeys.indexOf(e)]}getLatestPressingKey(e){let t=-1;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);t<i&&(t=i)}),t==-1?"":this.pressingKeys[t]}getOldestPressingKey(e){let t=1/0;return e.forEach(s=>{const i=this.pressingKeys.indexOf(s);i<t&&i!=-1&&(t=i)}),t==-1?"":this.pressingKeys[t]}getAllPressingKeys(e){return this.pressingKeys.filter(t=>e.includes(t))}}class Te{manager;type;index;constructor(e="keyboard",t=0){this.type=e,this.index=t,e=="keyboard"?this.manager=new Ce:e=="gamepad"?this.manager=new tt(t):e=="autoKeyboard"?this.manager=new Se:(console.log("不明なinput形式を指定されました"),this.type="keyboard",this.manager=new Ce)}get g$manager(){return this.manager}get g$type(){return this.type}get g$index(){return this.type}isAuto(){return this.manager instanceof Se}}class te{static instance;registering=!1;inputTypes=["keyboard"];inputs=[new Te("keyboard")];maxInputNumber=4;registerEventIds=[];registeredInputs=[];eventClassNames=["inputRegistered","finishRegister","inputAdded"];addEvent(e,t){return h.addEvent({classNames:e,handler:t})}constructor(){if(te.instance)return te.instance;te.instance=this,window.addEventListener("gamepadconnected",e=>{if(!this.inputTypes.includes(`gamepad:${e.gamepad.index}`)){this.inputTypes.push(`gamepad:${e.gamepad.index}`);const t=new Te("gamepad",e.gamepad.index);this.inputs.push(t),t.g$manager.start(),this.registering&&this.addRegisterEvent(t),h.executeEventsByClassName("inputAdded")}}),this.inputs[0].g$manager.start()}get g$registeredInputs(){return this.registeredInputs}get g$maxInputNumber(){return this.maxInputNumber}get g$registering(){return this.registering}get g$registeredInputNumber(){return this.registeredInputs.length}get g$inputs(){return this.inputs}set s$maxInputNumber(e){this.maxInputNumber=e}startRegister(){this.registering=!0,this.registeredInputs=[],this.registerEventIds=[],this.inputs.forEach(e=>{this.addRegisterEvent(e)}),this.start()}finishRegister(){this.registering&&(h.removeEvents(this.registerEventIds),this.registering=!1,h.executeEventsByClassName("finishRegister"))}addRegisterEvent(e){this.registerEventIds.push(e.g$manager.addEvent(["onKeydown","onButtondown","onStickActive"],()=>{this.registeredInputs.includes(e)||(this.registeredInputs.push(e),h.executeEventsByClassName("inputRegistered")),this.registeredInputs.length>=this.maxInputNumber&&this.finishRegister()}))}resetRegister(){this.registering=!1,this.registeredInputs=[],h.removeEvents(this.registerEventIds),this.inputs.forEach(e=>{h.removeEvents(e.g$manager.eventIds)})}start(){this.inputs.forEach(e=>{e.g$manager.start()})}stop(){this.inputs.forEach(e=>{e.g$manager.stop()})}addInput(e){this.inputs.includes(e)||(this.inputs.push(e),this.inputTypes.push(e.g$type))}removeVirtualInputs(){this.inputTypes=this.inputTypes.filter(e=>e=="keyboard"||e.includes("gamepad")),this.inputs.filter(e=>!["keyboard","gamepad"].includes(e.g$type)).forEach(e=>{e.g$manager.stop()}),this.inputs=this.inputs.filter(e=>["keyboard","gamepad"].includes(e.g$type)),this.registeredInputs=this.registeredInputs.filter(e=>["keyboard","gamepad"].includes(e.g$type))}register(e){this.registeredInputs.length>=this.maxInputNumber||(this.addInput(e),this.registeredInputs.includes(e)||(this.registeredInputs.push(e),h.executeEventsByClassName("inputRegistered")))}}const b=new te,ke=9,Ee=20,st=18,G=ke*2-1,q=Ee+st,Le=.5,S=100,K=S*2/Math.sqrt(3),se=8,ie=19,Me="#222233",ve={normal:{L:"#FF0000",J:"#FA7800",p:"#FFFF00",q:"#00FF00",U:"#0000FF",I:"#990099",g:"#AAAAAA"},ghost:{L:"#55000099",J:"#4D2D0099",p:"#55550099",q:"#00550099",U:"#00005599",I:"#44004499",g:"#44444499"}},De={width:8,color:"#494960"},Q={normal:{width:4,color:"#79798899"},ghost:{width:4,color:"#45455099"}},it="#88ddee66",v={width:3,height:3,gap:160,scale:{hold:1.4,normal:1},length:4,splitColor:"#00008888"},at=2e3,Be=4e3,Ae=3,pe={repeatTime:35,delayTime:135},nt=500,rt=30,Ke={removeLine:3,unput:3},ze=[{moveLeft:["button:14","stick:-0"],moveRight:["button:15","stick:+0"],moveDown:["button:13","stick:+1"],put:["button:4","button:6"],spinLeft:["button:0"],spinRight:["button:1"],unput:["button:2"],hold:["button:5","button:7"],removeLine:["button:3"],pause:["button:8","button:9"]}],qe=120,ot=10,J=[];class Ve{players=[];state={hasFinished:!1};winners=[];operateMemories;eventClassNames=["gameFinish"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),J.push(s),s}constructor(e){this.players=e,this.operateMemories=new Array(e.length).fill(void 0).map(()=>[]);const t=["put","move-left","move-right","move-down","spin-left","spin-right","unput","hold","removeLine"];e.forEach((s,i)=>{t.forEach(a=>{J.push(s.operator.addEvent([a],()=>{this.operateMemories[i].push({time:Math.floor(s.loop.g$elapsedTime),operateName:a})}))})})}get g$hasFinished(){return this.state.hasFinished}get g$isPlaying(){return this.players.some(e=>e.loop.g$isLooping)}remove(){h.removeEvents(J),this.players.forEach(e=>{e.g$element.remove()})}}class O{values;constructor(...e){if(e.length==0)throw new Error("0次元のベクトルは扱えません");const t=Array.isArray(e[0])?e[0]:e;if(t.filter(s=>Number.isNaN(s)).length!=0)throw new Error("ベクトルにNaNが含まれています");this.values=t}get array(){return this.values}get length(){return this.values.length}get size(){return Math.hypot(...this.values)}get unit(){if(this.isZero)throw new Error("零ベクトルを単位ベクトルにすることはできません");return this.multiple(1/this.size)}get isZero(){return this.values.filter(e=>e!=0).length==0}get copy(){return new O(this.values)}get normal(){if(this.length!=2)throw new Error("2次元のときのみ法線ベクトルを取得できます");const e=[this.values[1],-this.values[0]];return new O(e)}get argument(){if(this.length!=2)throw new Error("2次元のときのみ偏角を取得できます");return(Math.atan2(this.values[1],this.values[0])+Math.PI*2)%(Math.PI*2)}get(e){return this.values[e]}add(e){if(this.length!=e.length)throw new Error("次元が異なるベクトルです");const t=this.values.map((s,i)=>s+e.array[i]);return new O(t)}sub(e){if(this.length!=e.length)throw new Error("次元が異なるベクトルです");const t=this.values.map((s,i)=>s-e.array[i]);return new O(t)}dot(e){if(this.length!=e.length)throw new Error("次元が異なるベクトルです");const t=this.values.map((s,i)=>s*e.array[i]);return new O(t)}multiple(e){Number.isNaN(e)&&(console.error("NaNによるスカラー倍が実行されています"),e=1);const t=this.values.map(s=>s*e);return new O(t)}setSize(e){return this.unit.multiple(e)}cross(e){if(this.length!=e.length)throw new Error("次元が異なるベクトルです");if(this.length!=3)throw new Error("外積は3次元のときのみ実装されています");const t=[this.values[1]*e.array[2]-this.values[2]*e.array[1],this.values[2]*e.array[0]-this.values[0]*e.array[2],this.values[0]*e.array[1]-this.values[1]*e.array[0]];return new O(t)}rot(e){if(this.length!=2)throw new Error("回転は2次元のときのみ実装されています");return new O(this.values[0]*Math.cos(e)-this.values[1]*Math.sin(e),this.values[0]*Math.sin(e)+this.values[1]*Math.cos(e))}equals(e){if(this.length!=e.length)return!1;let t=!0;return this.values.forEach((s,i)=>{s-e.get(i)!=0&&(t=!1)}),t}getDistanceFrom(e){if(this.length!=e.length)throw new Error("次元が異なるベクトルです");return this.sub(e).size}getNearestVector(...e){if(e.length==0)throw new Error("長さ0の配列を渡されました");const t=Array.isArray(e[0])?e[0]:e;let s=1/0,i=0;return t.forEach((a,n)=>{const r=a.getDistanceFrom(this);r<s&&(s=r,i=n)}),t[i]}getFarthestVector(...e){if(e.length==0)throw new Error("長さ0の配列を渡されました");const t=Array.isArray(e[0])?e[0]:e;let s=0,i=0;return t.forEach((a,n)=>{const r=a.getDistanceFrom(this);s<r&&(s=r,i=n)}),t[i]}}const Ue=T("#playBackground"),H=document.createElement("canvas"),Ie=H.getContext("2d");Ue.appendChild(H);H.width=560;H.height=360;class lt{x=0;y=0;size=0;speed=0;opacity=0;angle=0;rotationSpeed=0;constructor(){this.reset()}reset(){this.x=Math.random()*H.width,this.y=H.height+20,this.size=20+Math.random()**1.2*40,this.speed=.6+Math.random()*1.5,this.opacity=.2+Math.random()*.5,this.angle=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.04}update(){this.y-=this.speed,this.angle+=this.rotationSpeed,this.y<-this.size&&this.reset()}draw(e){const t=new O(this.x,this.y),s=new O(0,-this.size/2*(Math.sqrt(3)/2)).rot(this.angle);e.beginPath(),e.moveTo(...s.rot(0).add(t).array),e.lineTo(...s.rot(2*Math.PI/3).add(t).array),e.lineTo(...s.rot(4*Math.PI/3).add(t).array),e.closePath(),e.fillStyle=`rgba(255,255,255,${this.opacity})`,e.fill()}}const ce=Ue.animate([{backgroundColor:"#88aaee"},{backgroundColor:"#aa88ee"},{backgroundColor:"#aaeeaa"},{backgroundColor:"#eeeeaa"},{backgroundColor:"#88aaee"}],{duration:25e3,direction:"normal",iterations:1/0}),We=Array.from({length:40},()=>new lt),ue=new le;ue.addEvent(["loop"],()=>{Ie.clearRect(0,0,H.width,H.height),We.forEach(o=>{o.update(),o.draw(Ie)})});const oe={reset:()=>{Ie.clearRect(0,0,H.width,H.height),We.forEach(o=>{o.reset()}),ue.reset(),ce.cancel()},start:()=>{ue.start(),ce.playState!="running"&&ce.play()},stop:()=>{ue.stop(),ce.pause()}};class F{static putShake=!0;static removeShake=!0;static playBackground=!0;static init(){this.loadData(),this.setupEvents()}static saveGraphicSetting(){const e=this.getEncodedSetting();try{localStorage.setItem("Pentamond3-graphicSetting",e)}catch{console.error("何らかの理由により設定の保存に失敗しました")}this.updateButtonStyle()}static updateButtonStyle(){T("#putShakeOn").style.color=this.putShake?"#ee8888":"",T("#putShakeOff").style.color=this.putShake?"":"#ee8888",T("#removeShakeOn").style.color=this.removeShake?"#ee8888":"",T("#removeShakeOff").style.color=this.removeShake?"":"#ee8888",T("#playBackgroundOn").style.color=this.playBackground?"#ee8888":"",T("#playBackgroundOff").style.color=this.playBackground?"":"#ee8888"}static loadData(){const e=localStorage.getItem("Pentamond3-graphicSetting");if(!e){this.saveGraphicSetting();return}const t=this.decode(e);this.putShake=t[0],this.removeShake=t[1],this.playBackground=t[2],this.updateButtonStyle()}static setupEvents(){I("#putShakeOn","click",()=>{this.putShake||(this.putShake=!0)}),I("#putShakeOff","click",()=>{this.putShake&&(this.putShake=!1)}),I("#removeShakeOn","click",()=>{this.removeShake||(this.removeShake=!0)}),I("#removeShakeOff","click",()=>{this.removeShake&&(this.removeShake=!1)}),I("#playBackgroundOn","click",()=>{this.playBackground||(this.playBackground=!0)}),I("#playBackgroundOff","click",()=>{this.playBackground&&(this.playBackground=!1)}),I("#graphicSetting button","click",()=>{this.saveGraphicSetting()})}static getEncodedSetting(){return Number.parseInt([this.putShake?"1":"0",this.removeShake?"1":"0",this.playBackground?"1":"0"].join(""),2)+""}static decode(e){const t=Number.parseInt(e,10).toString(2).split("").map(s=>s!="0");for(let s=0;3-t.length;s++)t.unshift(!1);return t}}class B{static context;static gain;static audio;static audioBuffer;static reversedBuffer;static volume=1;static sourceVolume=1;static onEnded={promise:Promise.resolve(),cancel:()=>{}};static logicalTime;static initialized=!1;static init(){if(this.initialized)throw new Error("BGM is already initialized! Ensure that you are not calling BGM.init() multiple times.");this.initialized=!0,this.context=new AudioContext,this.context.suspend(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.logicalTime=B.Time}static async fetch({src:e,loopStart:t,loopEnd:s,sourceVolume:i=1}){this.checkInit(),this.context.suspend(),this.sourceVolume=i,this.setVolume(this.volume);const a=await(await fetch(e)).arrayBuffer();this.audioBuffer=await this.context.decodeAudioData(a),this.reversedBuffer=this.reverseBuffer(this.audioBuffer),this.logicalTime.isReversed=!1,this.logicalTime.currentTime=0,this.logicalTime.lastUpdateTime=0,this.logicalTime.lastUpdateContextTime=this.context.currentTime,this.logicalTime.loopStart=t??0,this.logicalTime.loopEnd=s??this.audioBuffer.duration,this.logicalTime.duration=this.audioBuffer.duration,this.reconnect()}static play(){return this.checkInit(),this.context.resume()}static pause(){return this.checkInit(),this.context.suspend()}static async fadeOut(e){this.checkInit(),await this.fade(.001,e),await this.pause()}static async fadeIn(e){this.checkInit();const t=this.volume;this.setVolume(.001),await this.play(),await this.fade(t,e)}static fade(e,t){return this.checkInit(),this.gain.gain.cancelScheduledValues(0),this.gain.gain.linearRampToValueAtTime(e*this.sourceVolume,this.context.currentTime+t),new Promise(s=>{setTimeout(()=>{s()},t*1e3)})}static reverse(){this.checkInit(),this.logicalTime.isReversed=!this.logicalTime.isReversed,this.reconnect()}static setCurrentTime(e){this.checkInit(),this.logicalTime.setCurrentTime(this.context.currentTime,e),this.reconnect()}static getCurrentTime(){return this.checkInit(),this.logicalTime.updateCurrentTime(this.context.currentTime),this.logicalTime.currentTime}static isPlaying(){return this.checkInit(),this.context.state==="running"}static setVolume(e){this.checkInit(),this.gain.gain.cancelScheduledValues(0),this.volume=e,this.gain.gain.value=this.volume*this.sourceVolume}static getVolume(){return this.volume}static reverseBuffer(e){const t=this.context.createBuffer(e.numberOfChannels,e.length,e.sampleRate);for(let s=0;s<e.numberOfChannels;s++){const i=e.getChannelData(s),a=t.getChannelData(s);for(let n=0;n<i.length;n++)a[n]=i[i.length-n-1]}return t}static reconnect(){this.checkInit(),this.audio&&(this.audio.stop(),this.audio.disconnect(),this.onEnded.cancel()),this.audio=this.context.createBufferSource(),this.audio.loop=!0,this.audio.buffer=this.logicalTime.isReversed?this.reversedBuffer:this.audioBuffer,[this.audio.loopStart,this.audio.loopEnd]=this.logicalTime.getActualLoopTime(),this.audio.connect(this.gain),this.onEnded.promise=new Promise(e=>{this.onEnded.cancel=e,this.audio.onended=()=>{e()}}),this.logicalTime.updateCurrentTime(this.context.currentTime),this.audio.start(0,this.logicalTime.getActualOffset())}static checkInit(){if(!this.context)throw new Error("BGM is not initialized. Call BGM.init() before using BGM.")}}(o=>{class e{static currentTime=0;static lastUpdateTime=0;static lastUpdateContextTime=0;static loopStart=0;static loopEnd=0;static duration=0;static isReversed=!1;static setCurrentTime(s,i){i=this.bound(i),this.currentTime=i,this.lastUpdateTime=i,this.lastUpdateContextTime=s}static getActualOffset(){return this.isReversed?this.duration-this.currentTime:this.currentTime}static getActualLoopTime(){return this.isReversed?[this.duration-this.loopEnd,this.duration-this.loopStart]:[this.loopStart,this.loopEnd]}static updateCurrentTime(s){const i=s-this.lastUpdateContextTime;this.isReversed?this.currentTime=this.lastUpdateTime-i:this.currentTime=this.lastUpdateTime+i,this.currentTime=this.bound(this.currentTime),this.lastUpdateTime=this.currentTime,this.lastUpdateContextTime=s}static bound(s){const i=this.loopEnd-this.loopStart;return this.isReversed&&s<this.loopStart?this.loopEnd-(this.loopStart-s)%i:!this.isReversed&&s>this.loopEnd?this.loopStart+(s-this.loopStart)%i:s}}o.Time=e})(B||(B={}));class ae{static instance;flags=new Set;eventClassNames=["flagAdd","flagRemove","flagChanged"];addEvent(e,t){return h.addEvent({classNames:e,handler:t})}constructor(){if(ae.instance)return ae.instance;ae.instance=this}get g$size(){return this.flags.size}get g$flagNames(){return structuredClone(this.flags)}add(e){return this.flags.has(e)?!1:(this.flags.add(e),h.executeEventsByClassName("flagAdd"),h.executeEventsByClassName("flagAdd-"+e),h.executeEventsByClassName("flagChanged"),!0)}remove(e){return this.flags.delete(e)?(h.executeEventsByClassName("flagRemove"),h.executeEventsByClassName("flagRemove-"+e),h.executeEventsByClassName("flagChanged"),!0):!1}has(e){return this.flags.has(e)}hasAll(...e){return new Set(e).isSubsetOf(this.flags)}hasAny(...e){let t=!1;return e.forEach(s=>{if(this.flags.has(s)){t=!0;return}}),t}}const je=new ae;class C{static context;static gain;gain;audioBuffer;reversedBuffer;isReversed=!1;lastPlayTime=Date.now();isReady;static initialized=!1;static init(){if(this.initialized)throw new Error("Sound is already initialized! Ensure that you are not calling Sound.init() multiple times.");this.initialized=!0,this.context=new AudioContext,this.gain=this.context.createGain(),this.gain.connect(this.context.destination)}static setWholeVolume(e){C.checkInit(),this.gain.gain.value=e}static getWholeVolume(){return C.checkInit(),this.gain.gain.value}constructor({src:e,volume:t=.4}){C.checkInit(),this.gain=C.context.createGain(),this.gain.connect(C.gain),this.gain.gain.value=t,this.isReady=this.fetch(e)}play(){Date.now()-this.lastPlayTime<32||(this.lastPlayTime=Date.now(),this.reconnect())}reverse(){this.isReversed=!this.isReversed}clearReversal(){this.isReversed=!1}async fetch(e){C.checkInit();const t=await(await fetch(e)).arrayBuffer(),s=await C.context.decodeAudioData(t);this.audioBuffer=s;const i=this.reverseBuffer(this.audioBuffer);this.reversedBuffer=i}reverseBuffer(e){C.checkInit();const t=C.context.createBuffer(e.numberOfChannels,e.length,e.sampleRate);for(let s=0;s<e.numberOfChannels;s++){const i=e.getChannelData(s),a=t.getChannelData(s);for(let n=0;n<i.length;n++)a[n]=i[i.length-n-1]}return t}reconnect(){C.checkInit();const e=C.context.createBufferSource();e.buffer=this.isReversed?this.reversedBuffer:this.audioBuffer,e.connect(this.gain),e.start()}static checkInit(){if(!this.context)throw new Error("Sound is not initialized. Call Sound.init() before using Sound.")}}class ne{initialized=!1;static instance;eventClassNames=["selectorChanged"];addEvent(e,t){return h.addEvent({classNames:e,handler:t})}constructor(){if(ne.instance)return ne.instance;ne.instance=this}get g$initialized(){return this.initialized}init(){this.initialized||(p.init(),document.querySelectorAll(".back, [data-back]").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.back||"1");p.backPages(t)})}),document.querySelectorAll("[data-page]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&p.setPage(t)})}),document.querySelectorAll(".page[data-layer]").forEach(e=>{const t=e.dataset.layer;e.style.zIndex=t||"0"}),document.querySelectorAll(".page:has(.subPageNext)").forEach(e=>{const t=Array.from(e.querySelectorAll(".subPagePrev")),s=Array.from(e.querySelectorAll(".subPageNext"));t.forEach(i=>{i.addEventListener("click",()=>{p.setSubPage(this.getSubPageIndex(e)-1)})}),s.forEach(i=>{i.addEventListener("click",()=>{p.setSubPage(this.getSubPageIndex(e)+1)})})}),document.querySelectorAll(".scrollableContainer button").forEach(e=>{e.addEventListener("click",()=>{const t=this.getParentPageId(e),s=document.querySelector(`.selector[data-page=${t}]`);!t||!s||(s.innerText=e.innerText,document.getElementById(t)?.querySelectorAll(".scrollableContainer button").forEach(i=>{i.classList.remove("selectedValue")}),e.classList.add("selectedValue"),p.backPages(1),h.executeEventsByClassName("selectorChanged"),h.executeEventsByClassName(`selectorChanged-${t}`))})}),document.querySelectorAll(".page:has(.selector)").forEach(e=>{e.querySelectorAll(".selector").forEach(s=>{const i=s.dataset.page,a=document.querySelector(`#${i} .scrollableContainer .selectedValue`);a?s.innerText=a.innerText:s.innerText="未選択"})}),p.addEvent(["setPage"],()=>{const e=p.g$currentPage;if(!e)return;const t=e.querySelector(".scrollableContainer .selectedValue");t&&t.focus()}),this.initialized=!0)}getParentPageId(e){let t=e;for(;t.parentElement&&!t.classList.contains("page");)t=t.parentElement;return t.classList.contains("page")?t.id:""}getSelectedIndex(e){const t=document.getElementById(e),s=document.querySelector(`.selector[data-page=${e}`);return!t||!s?-1:Array.from(t.querySelectorAll(".scrollableContainer button")).findIndex(a=>a.classList.contains("selectedValue"))}selectByIndex(e,t){const s=document.getElementById(e),i=document.querySelector(`.selector[data-page=${e}`);if(!s||!i)return;const a=Array.from(s.querySelectorAll(".scrollableContainer button"));t<0||a.length<=t||(a.forEach(n=>{n.classList.remove("selectedValue")}),a[t].classList.add("selectedValue"),i.innerText=a[t].innerText)}getSubPageIndex(e){return!e||!e.querySelector(".subPage")?null:Array.from(e.querySelectorAll(".subPage")).findIndex(s=>s.style.display!="none")}scrollCenter(e){const t=e.clientHeight/2+e.getBoundingClientRect().y,s=e.parentElement;if(!s)return;const i=s.clientHeight/2+s.getBoundingClientRect().y;Math.abs(t-i)>s.clientHeight/2*.6&&e.scrollIntoView({block:"center",behavior:"smooth"})}}const j=new ne;let D,de="";const me=[{src:"assets/musics/つみきのおしろ.m4a"},{src:"assets/musics/ならべてトライアングル.m4a",sourceVolume:.6},{src:"assets/musics/おかたづけ.m4a"},{src:"assets/musics/さよならさんかく.m4a"},{src:"assets/musics/Top of the Pyramid.m4a"}];function ht(){B.init(),C.init(),D=[new C({src:"assets/sounds/Pentamond3-ボタン.mp3"}),new C({src:"assets/sounds/Pentamond3-フォーカス.mp3",volume:.15}),new C({src:"assets/sounds/モンド設置音.m4a"})],ct()}I("#pageStart","click",()=>{D[0].play()});I("button","click",()=>{D[0].play()});I("button","focus",()=>{D[1].play()});I('input[type="range"]',"input",()=>{D[0].play()});p.addEvent(["pageChanged-pageStart"],async()=>{await he({})});p.addEvent(["pageChanged-title"],async()=>{he(me[0])});p.addEvent(["pageChanged-musicSetting"],async()=>{he(me[0])});p.addEvent(["pageChanged-startEffect"],async()=>{await Je("bgmSelector1")});p.addEvent(["pageChanged-result"],async()=>{await he(me[2])});async function he({src:o,loopStart:e,loopEnd:t,sourceVolume:s=1}){if(!o){p.s$valid=!1,V.s$operable=!1,B.isPlaying()&&await B.pause(),de="",p.s$valid=!0,V.s$operable=!0;return}de!=o&&(p.s$valid=!1,V.s$operable=!1,await B.pause(),await B.fetch({src:o,loopStart:e,loopEnd:t,sourceVolume:s}),await B.play(),de=o,p.s$valid=!0,V.s$operable=!0)}p.addEvent(["pageBecomeValid"],()=>{je.remove("invalid")});p.addEvent(["pageBecomeInvalid"],()=>{je.add("invalid")});I("#bgmVolume","input",o=>{const e=parseInt(o.value);B.setVolume(e/10),Ze()});I("#seVolume","input",o=>{const e=parseInt(o.value);C.setWholeVolume(e/10),Ze()});j.addEvent(["selectorChanged-bgmSelector1"],()=>{Je("bgmSelector1")});function Je(o){const e=T(`[data-page="${o}"]`).innerText,t=me.find(s=>s.src.includes(e));if(t)return de="",he(t)}function Ze(){localStorage.setItem("Pentamond3-volumeSetting",(Math.round(B.getVolume()*10)*11+Math.round(C.getWholeVolume()*10)).toString(36))}function ct(){const o=localStorage.getItem("Pentamond3-volumeSetting");if(o){const e=Number.parseInt(o,36),t=Math.floor(e/11),s=e%11;B.setVolume(t/10),C.setWholeVolume(s/10),document.querySelector("#bgmVolume").value=t+"",document.querySelector("#seVolume").value=s+""}}class we{static playSetting={playerNumber:1,mode:1,maxGameTime:150,handy:[1]};static getPlaySetting(){return Object.freeze(structuredClone(this.playSetting))}static setEvents(){I("button[data-mode]","click",e=>{this.playSetting.playerNumber=1,this.playSetting.mode=Number(e.dataset.mode)}),I("button[data-player]","click",e=>{this.playSetting.playerNumber=Number(e.dataset.player)})}}class E{static gamepadConfigs=[];static setEvents(){let e=1;p.addEvent(["setPage-playerRegister"],async()=>{await Z(1);const{playerNumber:t}=we.getPlaySetting();e=t,this.startControllerRegistration(e)}),I("#playerRegister .back","click",()=>{b.resetRegister()}),I("#playPrepare .back","click",()=>{b.resetRegister()}),b.addEvent(["inputRegistered"],()=>{this.onInputRegistered(e)}),b.addEvent(["finishRegister"],()=>{T("#registerText").innerHTML='<div style="color:#d66">完了！</div>'}),I("#registerButton","click",()=>{this.onClickOk(e)})}static async onClickOk(e){if(b.g$registering)return;b.stop(),this.enablePlayerRegisterButtons(!1),await Z(500);const t=e==1?1:2;p.backPages(t,{eventIgnore:!0}),p.setPage("playPrepare"),this.enablePlayerRegisterButtons(!0),b.start()}static enablePlayerRegisterButtons(e){P("#playerRegister button").forEach(t=>{t.disabled=!e})}static startControllerRegistration(e){b.g$registeredInputNumber>0&&(b.removeVirtualInputs(),b.resetRegister()),Array.from(T("#connectionLabel").children).forEach(t=>{t.remove()}),T("#registerText").innerText=`登録したい入力機器のボタンを押してください：あと${e-b.g$registeredInputNumber}人`,this.gamepadConfigs=[],b.s$maxInputNumber=e,b.startRegister()}static onInputRegistered(e){const t=b.g$registeredInputs,s=document.createElement("div");s.dataset.inputType=t[t.length-1].g$type,s.classList.add("inputTypeIcon"),T("#connectionLabel").appendChild(s),T("#registerText").innerText=`登録したい入力機器のボタンを押してください：あと${e-b.g$registeredInputNumber}人`,this.gamepadConfigs.push(ze[0])}}class ut extends Ve{constructor(e){super(e),e.forEach((t,s)=>{this.addPlayerBehavior(s)})}start(){this.players.forEach(e=>{e.start()}),F.playBackground&&oe.start()}stop(){this.players.forEach(e=>{e.stop()}),F.playBackground&&oe.stop()}proceedPlayerFinish(){if(this.state.hasFinished)return;this.players.forEach(t=>{if(t.updateGameTime(),t.playInfo.gameTime==0){if(t.state.hasFinished)return;t.finish(),t.label.updateContents({gameTime:t.playInfo.gameTime+"",playTime:"",line:"",lastTrick:t.playInfo.lastTrick?t.playInfo.lastTrick.name:"　",chain:t.playInfo.chain+"",score:t.playInfo.score+""}),this.players.length!=1&&t.animations.finish.play()}});const e=this.players.filter(t=>!t.state.hasFinished);if(e.length==1&&this.players.length>=1)this.winners=[e[0]],e[0].updateGameTime();else if(e.length==0){const t=Math.max(...this.players.map(s=>(s.updateGameTime(),s.loop.g$elapsedTime)));this.winners=this.players.filter(s=>s.loop.g$elapsedTime==t)}this.winners.length>0&&(this.state.hasFinished=!0,this.stop(),this.players.forEach(t=>{t.label.updateContents({gameTime:t.playInfo.gameTime+"",playTime:"",line:"",lastTrick:t.playInfo.lastTrick?t.playInfo.lastTrick.name:"　",chain:t.playInfo.chain+"",score:t.playInfo.score+""}),t.playInfo.playTime=t.loop.g$elapsedTime}),P(".resultLabel").forEach(t=>{this.winners.length<this.players.length?t.innerHTML=`Player ${this.winners.map(s=>this.players.indexOf(s)+1).toString()} won!`:1<this.players.length?t.innerHTML="Draw":t.innerHTML=`Score : ${this.winners[0].playInfo.score}`}),h.executeListeningEvents("gameFinish",this.eventIds))}addPlayerBehavior(e){const t=this.players[e],s=t.input.g$manager,i=r=>{if(["ArrowLeft",...E.gamepadConfigs[e].moveLeft].includes(r))t.operator.move("left");else if(["ArrowRight",...E.gamepadConfigs[e].moveRight].includes(r))t.operator.move("right");else if(["ArrowDown",...E.gamepadConfigs[e].moveDown].includes(r))t.operator.move("down");else if(["ArrowUp",...E.gamepadConfigs[e].put].includes(r))t.operator.put();else if(["KeyC",...E.gamepadConfigs[e].spinLeft].includes(r))t.operator.spin("left");else if(["KeyV",...E.gamepadConfigs[e].spinRight].includes(r))t.operator.spin("right");else if(["KeyB",...E.gamepadConfigs[e].unput].includes(r))t.operator.unput();else if(["Space",...E.gamepadConfigs[e].hold].includes(r))t.operator.hold();else if(["Enter",...E.gamepadConfigs[e].removeLine].includes(r))t.operator.removeLine();else if(["KeyP",...E.gamepadConfigs[e].pause].includes(r)){if(!t.loop.g$isLooping||this.state.hasFinished)return;this.stop(),p.setPage("pause")}else return;$e(),t.updateCanvas()};t.label.s$visible={gameTime:!0,playTime:!1,line:!1,lastTrick:!0,chain:!0,score:!0};const a=()=>{t.label.updateContents({gameTime:t.playInfo.gameTime+"",playTime:"",line:"",lastTrick:t.playInfo.lastTrick?t.playInfo.lastTrick.name:"　",chain:t.playInfo.chain+"",score:t.playInfo.score+""})};let n=0;J.push(s.addEvent(["onKeydown","onButtondown","onStickActive"],()=>{t.loop.g$isLooping&&i(s.g$latestPressingKey)}),t.loop.addEvent(["loop"],()=>{const r=["ArrowLeft","ArrowRight","ArrowDown",...E.gamepadConfigs[e].moveLeft,...E.gamepadConfigs[e].moveRight,...E.gamepadConfigs[e].moveDown],l=s.getLatestPressingKey(r),u=Date.now()-s.getPressTime(l);u>=pe.delayTime&&l!=""?u-n>=pe.repeatTime&&(i(l),n=u):n=0,t.playInfo.playTime=t.loop.g$elapsedTime,a(),t.updateGameTime(),t.playInfo.gameTime<=rt?t.animations.timeWarning.playState!="running"&&t.animations.timeWarning.play():t.animations.timeWarning.playState=="running"&&t.animations.timeWarning.cancel(),t.playInfo.gameTime==0&&this.proceedPlayerFinish(),t.damageInfo.damageTask&&t.loop.g$elapsedTime-t.damageInfo.lastDamageTime>=Be&&t.animations.warning.playState!="running"&&(t.animations.caution.cancel(),t.animations.warning.play())}),t.operator.addEvent(["put"],()=>{t.playInfo.put+=1,t.playInfo.lastTrick=null,t.playInfo.chain=0,t.playInfo.score+=10,t.playInfo.penaltyTask=Math.max(t.playInfo.penaltyTask-1,0),t.damageInfo.damageTask&&(t.damageInfo.damageTask>t.damageInfo.attackTask?(console.log(`Player ${e+1} damage has offset : ${t.damageInfo.attackTask}`),t.damageInfo.damageTask-=t.damageInfo.attackTask,console.log(`Rest damage is ${t.damageInfo.damageTask}`),t.damageInfo.attackTask=0):(console.log(`Player ${e+1} attack has offset : ${t.damageInfo.damageTask}`),t.damageInfo.attackTask-=t.damageInfo.damageTask,t.damageInfo.damageTask?console.log(`Rest attack is ${t.damageInfo.attackTask}`):console.log("Damage and attack have just offset"),t.damageInfo.damageTask=0,t.animations.caution.cancel(),t.animations.warning.cancel())),t.damageInfo.damageTask&&t.loop.g$elapsedTime-t.damageInfo.lastDamageTime>=Be&&(console.log(`Player ${e+1} has damaged: ${t.damageInfo.damageTask}`),t.damage(),t.damageInfo.totalDamage+=t.damageInfo.damageTask),t.damageInfo.attackTask&&(console.log(`Player ${e+1} has attacked: ${t.damageInfo.attackTask}`),this.players.forEach((r,l)=>{l!=e&&r.addDamageTask(t.damageInfo.attackTask)}),t.damageInfo.totalAttack+=t.damageInfo.attackTask,t.damageInfo.attackTask=0),D[2].play()}),t.operator.addEvent(["unput"],()=>{t.playInfo.put-=1,t.playInfo.score-=10,t.playInfo.penalty+=Ke.unput,t.playInfo.unput+=1}),t.operator.addEvent(["hold"],()=>{t.playInfo.hold+=1}),t.operator.addEvent(["removeLine"],()=>{const r=t.operator.g$lastTrick;r?(t.playInfo.penaltyTask=0,["一列揃え(上)","一列揃え(下)"].includes(r.name)&&(t.playInfo.line+=1),t.playInfo.score+=t.playInfo.chain*100,t.playInfo.score+=(r.time+r.attack)*50,t.damageInfo.attackTask+=r.attack+Math.ceil(t.playInfo.chain/5),t.playInfo.maxChain=Math.max(t.playInfo.maxChain,t.playInfo.chain),t.playInfo.recovery+=r.time,t.playInfo.chain+=1,t.playInfo.trickCount+=1,F.removeShake&&t.animations.removeLineWithTrick.play()):(t.playInfo.penalty+=t.playInfo.penaltyTask,t.playInfo.penaltyTask=Ke.removeLine,t.playInfo.chain=0,F.removeShake&&t.animations.removeLineWithoutTrick.play()),t.playInfo.lastTrick=t.operator.g$lastTrick,t.playInfo.remove+=1}))}}class dt extends Ve{constructor(e){super(e),e.forEach((t,s)=>{this.addPlayerBehavior(s)})}start(){this.players.forEach(e=>{e.start()}),F.playBackground&&oe.start()}stop(){this.players.forEach(e=>{e.stop()}),F.playBackground&&oe.stop()}proceedPlayerFinish(){this.state.hasFinished||(this.winners=this.players.filter(e=>e.state.hasFinished),this.state.hasFinished=!0,this.stop(),this.players.length!=1&&this.players.filter(e=>!e.state.hasFinished).forEach(e=>{e.animations.finish.play()}),this.players.forEach(e=>{e.label.updateContents({gameTime:"",playTime:e.g$playTimeString,line:e.playInfo.line+"",lastTrick:"",chain:e.playInfo.chain+"",score:e.playInfo.score+""}),e.playInfo.playTime=e.loop.g$elapsedTime}),P(".resultLabel").forEach(e=>{this.winners.length<this.players.length?e.innerHTML=`Player ${this.winners.map(t=>this.players.indexOf(t)+1).toString()} won! : ${this.winners[0].g$playTimeString}`:1<this.players.length?e.innerHTML=`Draw : ${this.winners[0].g$playTimeString}`:e.innerHTML=`Time : ${this.winners[0].g$playTimeString}`}),h.executeListeningEvents("gameFinish",this.eventIds))}addPlayerBehavior(e){const t=this.players[e],s=t.input.g$manager,i=r=>{if(["ArrowLeft",...E.gamepadConfigs[e].moveLeft].includes(r))t.operator.move("left");else if(["ArrowRight",...E.gamepadConfigs[e].moveRight].includes(r))t.operator.move("right");else if(["ArrowDown",...E.gamepadConfigs[e].moveDown].includes(r))t.operator.move("down");else if(["ArrowUp",...E.gamepadConfigs[e].put].includes(r))t.operator.put();else if(["KeyC",...E.gamepadConfigs[e].spinLeft].includes(r))t.operator.spin("left");else if(["KeyV",...E.gamepadConfigs[e].spinRight].includes(r))t.operator.spin("right");else if(["KeyB",...E.gamepadConfigs[e].unput].includes(r))t.operator.unput();else if(["Space",...E.gamepadConfigs[e].hold].includes(r))t.operator.hold();else if(["Enter",...E.gamepadConfigs[e].removeLine].includes(r))t.operator.removeLine();else if(["KeyP",...E.gamepadConfigs[e].pause].includes(r)){if(!t.loop.g$isLooping||this.state.hasFinished)return;this.stop(),p.setPage("pause")}else return;$e(),t.updateCanvas()};t.label.s$visible={gameTime:!1,playTime:!0,line:!0,lastTrick:!1,chain:!0,score:!0};const a=()=>{t.label.updateContents({gameTime:"",playTime:t.g$playTimeString,line:t.playInfo.line+"",lastTrick:"",chain:t.playInfo.chain+"",score:t.playInfo.score+""})};let n=0;t.canvas.guideBorder=!0,J.push(s.addEvent(["onKeydown","onButtondown","onStickActive"],()=>{t.loop.g$isLooping&&i(s.g$latestPressingKey)}),t.loop.addEvent(["loop"],()=>{const r=["ArrowLeft","ArrowRight","ArrowDown",...E.gamepadConfigs[e].moveLeft,...E.gamepadConfigs[e].moveRight,...E.gamepadConfigs[e].moveDown],l=s.getLatestPressingKey(r),u=Date.now()-s.getPressTime(l);u>=pe.delayTime&&l!=""?u-n>=pe.repeatTime&&(i(l),n=u):n=0,t.playInfo.playTime=t.loop.g$elapsedTime,a()}),t.operator.addEvent(["put"],()=>{t.playInfo.put+=1,t.playInfo.lastTrick=null,t.playInfo.chain=0,t.playInfo.score+=10}),t.operator.addEvent(["unput"],()=>{t.playInfo.put-=1,t.playInfo.score-=10,t.playInfo.unput+=1}),t.operator.addEvent(["hold"],()=>{t.playInfo.hold+=1}),t.operator.addEvent(["removeLine"],()=>{const r=t.operator.g$lastTrick;r&&["一列揃え(上)","一列揃え(下)"].includes(r.name)?(t.playInfo.line+=1,t.playInfo.score+=t.playInfo.chain*100,t.playInfo.score+=(r.time+r.attack)*50,t.playInfo.chain+=1,t.playInfo.maxChain=Math.max(t.playInfo.maxChain,t.playInfo.chain),t.canvas.guideBorderHeight=15-t.playInfo.line,t.canvas.paintPlayCanvas(),F.removeShake&&t.animations.removeLineWithTrick.play()):(t.playInfo.chain=0,F.removeShake&&t.animations.removeLineWithoutTrick.play()),t.playInfo.lastTrick=t.operator.g$lastTrick,t.playInfo.remove+=1,t.playInfo.line>=15&&(t.finish(),this.proceedPlayerFinish())}))}}class Re{static parser=new DOMParser;static setupSavedReplayPage(e){const t=T("#savedReplay .options");t.querySelectorAll(".replayDataContainer").forEach(a=>{a.remove()});const s=[],i=[];for(const a of e){const{replayDataContainer:n,replayButton:r,deleteButton:l}=this.createReplayDataContainer(a);t.prepend(n),s.push(r),i.push(l)}return t.querySelectorAll("button").forEach(a=>{V.setHoverHighlight(a)}),P("#savedReplay .replayButton").forEach((a,n)=>{a.dataset.mapping=`[0,${n}]`}),P("#savedReplay .replayDeleteButton").forEach((a,n)=>{a.dataset.mapping=`[1,${n}]`}),T("#savedReplay .back").dataset.mapping=`[0,${e.length}]`,{deleteButtons:i,replayButtons:s}}static createReplayDataContainer(e){const t=new Date(e.date),s=`
            <div class="replayDataContainer">
                <button class="replayButton">${this.getDateString(t)}</button>
                <div class="replayDataDescription">${this.createReplayDataDescription(e)}</div>
                <button class="replayDeleteButton"></button>
            </div>
        `,i=this.parser.parseFromString(s,"text/html").body.firstElementChild,a=i.querySelector(".replayButton"),n=i.querySelector(".replayDeleteButton");return{replayButton:a,deleteButton:n,replayDataContainer:i}}static getDateString(e){const t=`${e.getHours()}`,s=`${e.getMonth()+1}`;return`
            ${e.getFullYear()}/${s.length===1?"0"+s:s}/${e.getDate()}
            ${t.length===1?"&nbsp;&nbsp;&nbsp;"+t:t} :
            ${e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes()} :
            ${e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds()}
        `}static createReplayDataDescription(e){const t=e.nextData.length==1?"ソロ":"マルチ",s=this.stringifyMode(e.playSetting.mode),i=(e.finishTime/1e3).toFixed(2);return`${t} : ${s}<br>時間: ${i}`}static stringifyMode(e){switch(e){case 1:return"サバイバル";case 2:return"十五列揃え";default:return"不明なモード"}}static createTempReplayButton(e){const t=new Date(e),s=document.createElement("button");s.classList.add("replayButton"),s.innerHTML=`${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes()}:${t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds()}`;const i=document.createElement("button");i.classList.add("replaySaveButton");const a=document.createElement("div");a.classList="replayDataContainer",a.appendChild(s),a.appendChild(i),a.querySelectorAll("button").forEach(r=>{r.addEventListener("mouseover",()=>{r.focus()}),r.addEventListener("mouseleave",()=>{document.activeElement==r&&r.blur()})}),T("#replay .options").prepend(a);let n=0;return P("#replay .replayButton").forEach((r,l)=>{r.dataset.mapping=`[0,${l}]`,n++}),P("#replay .replaySaveButton").forEach((r,l)=>{r.dataset.mapping=`[1,${l}]`}),T("#replay .back").dataset.mapping=`[0,${n}]`,{replayButton:s,saveButton:i}}}function pt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var be={exports:{}},Ne;function gt(){return Ne||(Ne=1,(function(o){var e=(function(){var t=String.fromCharCode,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",a={};function n(l,u){if(!a[l]){a[l]={};for(var g=0;g<l.length;g++)a[l][l.charAt(g)]=g}return a[l][u]}var r={compressToBase64:function(l){if(l==null)return"";var u=r._compress(l,6,function(g){return s.charAt(g)});switch(u.length%4){default:case 0:return u;case 1:return u+"===";case 2:return u+"==";case 3:return u+"="}},decompressFromBase64:function(l){return l==null?"":l==""?null:r._decompress(l.length,32,function(u){return n(s,l.charAt(u))})},compressToUTF16:function(l){return l==null?"":r._compress(l,15,function(u){return t(u+32)})+" "},decompressFromUTF16:function(l){return l==null?"":l==""?null:r._decompress(l.length,16384,function(u){return l.charCodeAt(u)-32})},compressToUint8Array:function(l){for(var u=r.compress(l),g=new Uint8Array(u.length*2),d=0,m=u.length;d<m;d++){var L=u.charCodeAt(d);g[d*2]=L>>>8,g[d*2+1]=L%256}return g},decompressFromUint8Array:function(l){if(l==null)return r.decompress(l);for(var u=new Array(l.length/2),g=0,d=u.length;g<d;g++)u[g]=l[g*2]*256+l[g*2+1];var m=[];return u.forEach(function(L){m.push(t(L))}),r.decompress(m.join(""))},compressToEncodedURIComponent:function(l){return l==null?"":r._compress(l,6,function(u){return i.charAt(u)})},decompressFromEncodedURIComponent:function(l){return l==null?"":l==""?null:(l=l.replace(/ /g,"+"),r._decompress(l.length,32,function(u){return n(i,l.charAt(u))}))},compress:function(l){return r._compress(l,16,function(u){return t(u)})},_compress:function(l,u,g){if(l==null)return"";var d,m,L={},N={},A="",W="",w="",M=2,x=3,k=2,$=[],c=0,y=0,f;for(f=0;f<l.length;f+=1)if(A=l.charAt(f),Object.prototype.hasOwnProperty.call(L,A)||(L[A]=x++,N[A]=!0),W=w+A,Object.prototype.hasOwnProperty.call(L,W))w=W;else{if(Object.prototype.hasOwnProperty.call(N,w)){if(w.charCodeAt(0)<256){for(d=0;d<k;d++)c=c<<1,y==u-1?(y=0,$.push(g(c)),c=0):y++;for(m=w.charCodeAt(0),d=0;d<8;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1}else{for(m=1,d=0;d<k;d++)c=c<<1|m,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=0;for(m=w.charCodeAt(0),d=0;d<16;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1}M--,M==0&&(M=Math.pow(2,k),k++),delete N[w]}else for(m=L[w],d=0;d<k;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1;M--,M==0&&(M=Math.pow(2,k),k++),L[W]=x++,w=String(A)}if(w!==""){if(Object.prototype.hasOwnProperty.call(N,w)){if(w.charCodeAt(0)<256){for(d=0;d<k;d++)c=c<<1,y==u-1?(y=0,$.push(g(c)),c=0):y++;for(m=w.charCodeAt(0),d=0;d<8;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1}else{for(m=1,d=0;d<k;d++)c=c<<1|m,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=0;for(m=w.charCodeAt(0),d=0;d<16;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1}M--,M==0&&(M=Math.pow(2,k),k++),delete N[w]}else for(m=L[w],d=0;d<k;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1;M--,M==0&&(M=Math.pow(2,k),k++)}for(m=2,d=0;d<k;d++)c=c<<1|m&1,y==u-1?(y=0,$.push(g(c)),c=0):y++,m=m>>1;for(;;)if(c=c<<1,y==u-1){$.push(g(c));break}else y++;return $.join("")},decompress:function(l){return l==null?"":l==""?null:r._decompress(l.length,32768,function(u){return l.charCodeAt(u)})},_decompress:function(l,u,g){var d=[],m=4,L=4,N=3,A="",W=[],w,M,x,k,$,c,y,f={val:g(0),position:u,index:1};for(w=0;w<3;w+=1)d[w]=w;for(x=0,$=Math.pow(2,2),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;switch(x){case 0:for(x=0,$=Math.pow(2,8),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;y=t(x);break;case 1:for(x=0,$=Math.pow(2,16),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;y=t(x);break;case 2:return""}for(d[3]=y,M=y,W.push(y);;){if(f.index>l)return"";for(x=0,$=Math.pow(2,N),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;switch(y=x){case 0:for(x=0,$=Math.pow(2,8),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;d[L++]=t(x),y=L-1,m--;break;case 1:for(x=0,$=Math.pow(2,16),c=1;c!=$;)k=f.val&f.position,f.position>>=1,f.position==0&&(f.position=u,f.val=g(f.index++)),x|=(k>0?1:0)*c,c<<=1;d[L++]=t(x),y=L-1,m--;break;case 2:return W.join("")}if(m==0&&(m=Math.pow(2,N),N++),d[y])A=d[y];else if(y===L)A=M+M.charAt(0);else return null;W.push(A),d[L++]=M+A.charAt(0),m--,M=A,m==0&&(m=Math.pow(2,N),N++)}}};return r})();o!=null?o.exports=e:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return e})})(be)),be.exports}var mt=gt();const xe=pt(mt),Ye=["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","KeyC","KeyV","KeyB","Space","Enter"],Qe=["L","J","p","q","U","I"],Xe=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g"];async function Oe(o){const e=o.inputData.map(n=>n.map((r,l)=>(n[l].time-(l==0?0:n[l-1].time)).toString(5)+(Ye.indexOf(r.keyCode)+5).toString(36)).join("")),t=o.nextData.map(n=>n.map(r=>Qe.indexOf(r)+"").join("")),s=o.nuisanceBlockData.map(n=>n.map(r=>Xe[r]).join("")),i=[e,t,[o.playSetting.playerNumber,o.playSetting.mode,o.playSetting.maxGameTime,o.playSetting.handy],o.finishTime,o.finishPlayers,s,o.date];return xe.compressToUTF16(JSON.stringify(i))}async function ft(o){const e=JSON.parse(xe.decompressFromUTF16(o)),t=e[0].map(a=>a.match(/[0-4]+[^0-4]*|[^0-4]+/g)).map(a=>a.map((n,r)=>({time:yt(a.filter((l,u)=>u<=r).map(l=>Number.parseInt(l.slice(0,-1),5))),keyCode:Ye[Number.parseInt(a[r].slice(-1),36)-5],type:"downup"}))),s=e[1].map(a=>a.split("").map(n=>Qe[parseInt(n)])),i=e[5].map(a=>a.split("").map(n=>Xe.indexOf(n)));return{inputData:t,nextData:s,playSetting:{playerNumber:e[2][0],mode:e[2][1],maxGameTime:e[2][2],handy:e[2][3]},finishTime:e[3],finishPlayers:e[4],nuisanceBlockData:i,date:e[6]}}function yt(o){let e=0;return o.forEach(t=>{e+=t}),e}class R{static tempDataList=[];static addTempData(e,t){for(this.tempDataList.push(e);this.tempDataList.length>t;)this.tempDataList.shift(),T("#replay .replayDataContainer:first-child").remove()}static getDataSize(){return new Blob([localStorage.getItem("Pentamond3-replayData")??"[]"]).size}static createReplayData(e,t,s){const i=t.operateMemories.map(g=>g.map(({time:d,operateName:m})=>({time:d,keyCode:this.convertOperateName(m),type:"downup"}))),a=e.map(g=>g.operator.g$nextMemory),n=Math.max(...e.map(g=>g.playInfo.playTime)),r=e.map((g,d)=>g.playInfo.playTime==n?d+1:-1).filter(g=>g!=-1),l=e.map(g=>g.nuisanceMondManager.g$spawnCoordinateMemory);return structuredClone({inputData:i,nextData:a,playSetting:s,finishTime:n,finishPlayers:r,nuisanceBlockData:l,date:Date.now()})}static convertOperateName(e){return e=="put"?"ArrowUp":e=="move-left"?"ArrowLeft":e=="move-right"?"ArrowRight":e=="move-down"?"ArrowDown":e=="spin-left"?"KeyC":e=="spin-right"?"KeyV":e=="unput"?"KeyB":e=="hold"?"Space":e=="removeLine"?"Enter":""}static async removeSavedReplayData(e){const s=(await this.getReplayDataList()).filter(n=>n.date!=e.date),i=await Promise.all(s.map(n=>Oe(n))),a=JSON.stringify(i);localStorage.setItem("Pentamond3-replayData",a)}static async getReplayDataList(){const e=localStorage.getItem("Pentamond3-replayData"),t=e?JSON.parse(e):[];return await Promise.all(t.map(i=>ft(i)))}static getDateList(){const e=localStorage.getItem("Pentamond3-replayData");return(e?JSON.parse(e):[]).map(s=>xe.decompressFromUTF16(s)).map(s=>JSON.parse(s)).map(s=>s[6])}static async saveReplayData(e,{onOverMax:t,onError:s}){const i=this.getDateList();if(i.includes(e.date))return!1;if(i.length>=10)return t(),!1;const a=await this.getReplayDataList();for(a.push(e),a.sort((l,u)=>l.date-u.date);a.length>=11;)a.shift();const n=await Promise.all(a.map(l=>Oe(l)));try{localStorage.setItem("Pentamond3-replayData",JSON.stringify(n))}catch{return s(),!1}const r=this.getDataSize();return console.log(`The sum of size of replayData is ${r}byte`),!0}}class Fe{static setTempReplayPageEvent(e,{replayButton:t,saveButton:s}){t.addEventListener("click",()=>{const a=P("#replay .replayButton").findIndex(n=>n==t);D[0].play(),z.startReplay(e.at(-a-1))}),t.addEventListener("focus",()=>{D[1].play(),j.scrollCenter(t.parentElement)}),s.addEventListener("click",async()=>{const a=P("#replay .replaySaveButton").findIndex(r=>r==s);await U.save(e.at(-a-1))&&(D[0].play(),U.setupSavedReplayPage(),s.classList.add("replaySavedButton"))}),s.addEventListener("focus",async()=>{D[1].play(),j.scrollCenter(s.parentElement)})}static setSavedReplayPageEvent(e,{replayButtons:t,deleteButtons:s}){t.forEach((i,a)=>{i.addEventListener("click",()=>{D[0].play(),z.startReplay(e[a])}),i.addEventListener("focus",()=>{D[1].play(),j.scrollCenter(i.parentElement)})}),s.forEach((i,a)=>{i.addEventListener("click",()=>{this.onClickDeleteButton(e[a]),D[0].play()}),i.addEventListener("focus",()=>{D[1].play(),j.scrollCenter(i.parentElement)})})}static async onClickDeleteButton(e){if(!await this.checkApprove())return;const s=R.tempDataList.findIndex(i=>i.date==e.date);P(".replaySaveButton")[R.tempDataList.length-s-1]?.classList.remove("replaySavedButton"),await R.removeSavedReplayData(e),p.backPages(2,{eventIgnore:!0}),await U.setupSavedReplayPage(),p.setPage("savedReplay")}static checkApprove(){p.setPage("replayDeleteAlert");const e=T("#replayDeleteConfirmButton");e.disabled=!0,e.style.opacity="0";const t=T("#replayDeleteAlert .back");return Z(1500).then(()=>{e.disabled=!1,e.style.opacity="1"}),new Promise(s=>{const i=new AbortController;e.addEventListener("click",()=>{s(!0),i.abort()},{signal:i.signal}),t.addEventListener("click",()=>{s(!1),i.abort()},{signal:i.signal})})}}class U{static getDataSize(){return R.getDataSize()}static async setupSavedReplayPage(){const e=await R.getReplayDataList(),t=Re.setupSavedReplayPage(e);Fe.setSavedReplayPageEvent(e,t)}static addTempData({players:e,game:t,playSetting:s}){const i=R.createReplayData(e,t,s);R.addTempData(i,ot);const a=Re.createTempReplayButton(i.date);Fe.setTempReplayPageEvent(R.tempDataList,a)}static save(e){return R.saveReplayData(e,{onOverMax:()=>{p.setPage("replaySaveAlert")},onError:()=>{p.setPage("replaySaveAlert2")}})}static updateTempReplaySaveButton(){const e=R.getDateList(),t=P("#replay .replaySaveButton");t.forEach(s=>{const i=t.findIndex(n=>n==s),a=R.tempDataList.at(-i-1);e.includes(a.date)&&s.classList.add("replaySavedButton")})}static saveLastOne(){return this.save(R.tempDataList.at(-1))}}class vt{kind="g";direction=!0;visible=!1;constructor(){}get g$kind(){return this.kind}get g$direction(){return this.direction}get g$visible(){return this.visible}get g$shapeInfo(){return[this.direction||!this.visible,this.visible]}get g$property(){return[this.kind,this.direction,this.visible]}set s$kind(e){console.assert(!this.visible,"表示中に種類を変更しないでください"),this.kind=e}set s$direction(e){console.assert(!this.visible,"表示中に方向を変更しないでください"),this.direction=e}set s$visible(e){this.visible=e}set s$property([e,t,s]){this.kind=e,this.direction=t,this.visible=s}}const Ge={L:[[[0,0],[-1,0],[-2,0],[1,0],[1,-1]],[[0,0],[1,0],[2,0],[0,-1],[-1,-1]],[[0,0],[1,0],[1,-1],[0,1],[1,1]],[[0,0],[-1,0],[-1,1],[1,0],[2,0]],[[0,0],[-1,0],[-2,0],[0,1],[1,1]],[[0,0],[0,-1],[-1,-1],[-1,0],[-1,1]]],J:[[[0,0],[-1,0],[-1,-1],[1,0],[2,0]],[[0,0],[0,-1],[1,-1],[1,0],[1,1]],[[0,0],[0,1],[-1,1],[1,0],[2,0]],[[0,0],[-1,0],[-2,0],[1,0],[1,1]],[[0,0],[-1,0],[-1,-1],[0,1],[-1,1]],[[0,0],[-1,-0],[-2,-0],[0,-1],[1,-1]]],p:[[[0,-1],[0,0],[1,0],[2,0],[-1,0]],[[-1,0],[0,0],[0,1],[1,1],[1,0]],[[0,-1],[0,0],[1,0],[-1,1],[-1,0]],[[1,0],[0,0],[-1,0],[-2,0],[0,1]],[[-1,0],[0,0],[1,0],[-1,-1],[0,-1]],[[0,1],[0,0],[-1,0],[1,-1],[1,0]]],q:[[[0,-1],[0,0],[1,0],[-2,0],[-1,0]],[[0,1],[0,0],[1,0],[-1,-1],[-1,0]],[[-1,0],[0,0],[1,0],[1,-1],[0,-1]],[[-1,0],[0,0],[1,0],[2,0],[0,1]],[[0,-1],[0,0],[-1,0],[1,1],[1,0]],[[-1,0],[0,0],[1,0],[-1,1],[0,1]]],U:[[[0,0],[1,0],[1,-1],[-1,0],[-1,-1]],[[0,0],[1,0],[2,0],[0,-1],[1,-1]],[[0,0],[1,0],[2,0],[0,1],[1,1]],[[0,0],[1,0],[1,1],[-1,0],[-1,1]],[[0,0],[-1,0],[-2,0],[0,1],[-1,1]],[[0,0],[-1,0],[-2,0],[0,-1],[-1,-1]]],I:[[[0,0],[1,0],[2,0],[-1,0],[-2,0]],[[0,0],[1,0],[1,1],[0,-1],[-1,-1]],[[0,0],[1,0],[1,-1],[0,1],[-1,1]],[[0,0],[1,0],[2,0],[-1,0],[-2,0]],[[0,0],[0,1],[1,1],[-1,0],[-1,-1]],[[0,0],[0,-1],[1,-1],[-1,0],[-1,1]]],g:[[[0,0],[1,0],[2,0],[-1,0],[-2,0]],[[0,0],[1,0],[1,1],[0,-1],[-1,-1]],[[0,0],[1,0],[1,-1],[0,1],[-1,1]],[[0,0],[1,0],[2,0],[-1,0],[-2,0]],[[0,0],[0,1],[1,1],[-1,0],[-1,-1]],[[0,0],[0,-1],[1,-1],[-1,0],[-1,1]]]},bt={L:[[[[0,0],[-1,0]],[[0,0],[0,-1]],[[0,0],[-1,0],[1,0],[-1,-1],[0,-1],[1,-1]],[[0,0],[1,0],[-1,0],[0,-1],[1,-1]],[[0,0],[1,0]],[[0,0],[-1,0],[1,0],[-1,-1],[0,-1]]],[[[0,0],[0,-1]],[[0,0],[1,0],[1,-1],[2,-1]],[[0,0],[1,0],[-1,0],[1,-1]],[[0,0],[-1,0],[0,-1]],[[0,0],[-1,0],[0,-1],[-1,-1]],[[0,0],[1,0],[-1,0],[-1,-1],[1,-1],[-2,-1],[0,-2]]]],J:[[[[0,0],[0,-1]],[[0,0],[-1,0],[1,0],[1,-1],[-1,-1],[2,-1],[0,-2]],[[0,0],[1,0],[0,-1],[1,-1]],[[0,0],[1,0],[0,-1]],[[0,0],[-1,0],[1,0],[-1,-1]],[[0,0],[-1,0],[-1,-1],[-2,-1]]],[[[0,0],[1,0]],[[0,0],[1,0],[-1,0],[1,-1],[0,-1]],[[0,0],[-1,0]],[[0,0],[-1,0],[1,0],[0,-1],[-1,-1]],[[0,0],[1,0],[-1,0],[1,-1],[0,-1],[-1,-1]],[[0,0],[0,-1]]]],p:[[[[0,0],[0,-1]],[[0,0],[1,0],[0,-1]],[[0,0],[1,0],[0,-1],[1,-1]],[[0,0],[-1,0]],[[0,0],[0,-1]],[[0,0],[-1,0],[1,0],[0,-1]]],[[[0,0],[0,-1]],[[0,0],[-1,0],[1,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[0,-1],[1,-1],[2,-1],[1,-2]],[[0,0],[1,0],[-1,0],[0,-1]]]],q:[[[[0,0],[0,-1]],[[0,0],[-1,0],[1,0],[0,-1]],[[0,0],[-1,0],[0,-1],[-1,-1],[-2,-1],[-1,-2]],[[0,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[0,-1]]],[[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[1,0]],[[0,0],[-1,0],[0,-1],[-1,-1]],[[0,0],[-1,0],[0,-1]]]],U:[[[[0,0],[-1,0]],[[0,0],[0,-1]],[[0,0],[1,0],[0,-1]],[[0,0],[1,0],[0,-1],[1,-1]],[[0,0],[0,1]],[[0,0],[-1,0]]],[[[0,0],[1,0]],[[0,0],[1,0]],[[0,0],[0,1]],[[0,0],[-1,0],[0,-1],[-1,-1]],[[0,0],[-1,0],[0,-1]],[[0,0],[0,-1]]]],I:[[[[0,0],[0,-1]],[[0,0],[0,-1],[1,-1],[2,-1]],[[0,0],[-1,0],[1,0],[0,-1],[-1,-1],[1,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[0,-1]],[[0,0],[-1,0],[1,0],[-2,0],[-3,0],[-2,-1],[0,-1],[1,-1]]],[[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[2,0],[3,0],[2,-1],[0,-1],[-1,-1]],[[0,0],[-1,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[0,-1],[1,-1],[-1,-1]],[[0,0],[0,-1],[-1,-1],[-2,-1]]]],g:[[[[0,0],[0,-1]],[[0,0],[0,-1],[1,-1],[2,-1]],[[0,0],[-1,0],[1,0],[0,-1],[-1,-1],[1,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[0,-1]],[[0,0],[-1,0],[1,0],[-2,0],[-3,0],[-2,-1],[0,-1],[1,-1]]],[[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[2,0],[3,0],[2,-1],[0,-1],[-1,-1]],[[0,0],[-1,0],[0,-1]],[[0,0],[0,-1]],[[0,0],[1,0],[-1,0],[0,-1],[1,-1],[-1,-1]],[[0,0],[0,-1],[-1,-1],[-2,-1]]]]},Tt={right:[[1,0]],left:[[-1,0]],down:[[0,1],[-1,1],[1,1]]},kt=[{name:"一列揃え(上)",time:10,attack:10,shape:[[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0]]},{name:"一列揃え(上)",time:10,attack:10,shape:[[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0]]},...Et(),{name:"地殻変動(上)",time:16,attack:8,shape:[[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!1],[!0,!1],[!0,!1],[!0,!1],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0]]},{name:"地殻変動(下)",time:16,attack:8,shape:[[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!1],[!0,!1],[!0,!1],[!0,!1],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0]]},{name:"トゲトゲ(上)",time:30,attack:20,shape:[[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0],[!0,!1],[!0,!0]]},{name:"トゲトゲ(下)",time:30,attack:20,shape:[[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0],[!0,!1],[!1,!0]]},{name:"牙(上)",time:50,attack:40,shape:[[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0]]},{name:"牙(下)",time:50,attack:40,shape:[[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0],[!0,!1],[!0,!0],[!0,!1],[!1,!0]]},{name:"三つ子山",time:15,attack:10,shape:[[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!1,!0],[!0,!0]]},{name:"五人囃子",time:30,attack:15,shape:[[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0],[!0,!0],[!0,!1],[!0,!0],[!1,!0]]}];function Et(){const o=[];for(let e=1;e<16;e++){const t=[];for(let s=0;s<e;s++)t.push(s%2===0?"up":"down");t.push("none");for(let s=1;s<17-e;s++)t.push((s+e+1)%2===0?"up":"down");o.push({name:"地割れ(上)",time:8,attack:9,shape:t.map(He)})}for(let e=1;e<16;e++){const t=[];for(let s=0;s<e;s++)t.push(s%2===1?"up":"down");t.push("none");for(let s=1;s<17-e;s++)t.push((s+e+1)%2===1?"up":"down");o.push({name:"地割れ(下)",time:8,attack:9,shape:t.map(He)})}return o}function He(o){switch(o){case"up":return[!0,!0];case"down":return[!1,!0];case"none":return[!0,!1]}}class It{blocks;constructor(){this.blocks=new Array(G);for(let e=0;e<G;e++){this.blocks[e]=new Array(q);for(let t=0;t<q;t++)this.blocks[e][t]=new vt}}get g$blockProperties(){return this.blocks.map(e=>e.map(t=>t.g$property))}getBlockProperty(e,t){return this.blocks[e][t].g$property}canDisplayMonoiamond(e){return e.isOnPlayCanvas()?[-1,0,1].every(t=>!this.existDisturbMondWith(e,t)):!1}existDisturbMondWith(e,t){return e.g$x+t<0||G<=e.g$x+t?!1:t==0?this.blocks[e.g$x][e.g$y].g$visible:this.blocks[e.g$x+t][e.g$y].g$visible&&this.blocks[e.g$x+t][e.g$y].g$direction==e.g$direction}displayMonoiamond(e){this.canDisplayMonoiamond(e)&&(this.blocks[e.g$x][e.g$y].s$property=[e.g$kind,e.g$direction,!0],e.s$visible=!0)}remove(e,t){this.blocks[e][t].s$visible=!1}removeMonoiamond(e){e.g$visible&&(this.remove(e.g$x,e.g$y),e.s$visible=!1)}canDisplayPentiamond(e){return e.g$monoiamonds.every(t=>this.canDisplayMonoiamond(t))}displayPentiamond(e){this.canDisplayPentiamond(e)&&(e.g$monoiamonds.forEach(t=>{this.displayMonoiamond(t)}),e.s$visible=!0)}removePentiamond(e){e.g$visible&&(e.g$monoiamonds.forEach(t=>{this.removeMonoiamond(t)}),e.s$visible=!1)}spin(e,t){if(!e.g$visible)return!1;this.removePentiamond(e);const s=bt[e.g$kind][t=="right"?0:1][e.g$direction],i=e.g$x,a=e.g$y;e.s$direction=e.g$direction+(t=="right"?1:-1);for(let n=0;n<s.length;n++)if(e.s$position=[i+s[n][0],a+s[n][1]],this.canDisplayPentiamond(e))return this.displayPentiamond(e),!0;return e.s$direction=e.g$direction+(t=="right"?-1:1),e.s$position=[i,a],this.displayPentiamond(e),!1}move(e,t){if(!e.g$visible)return!1;this.removePentiamond(e);const[s,i]=e.g$position,a=Tt[t];for(let n=0;n<a.length;n++)if(e.s$position=[s+a[n][0],i+a[n][1]],this.canDisplayPentiamond(e))return this.displayPentiamond(e),!0;return e.s$position=[s,i],this.displayPentiamond(e),!1}canFall(e){if(!e.g$visible)return!1;const t=e.g$y;this.removePentiamond(e),e.s$y=t+1;const s=this.canDisplayPentiamond(e);return e.s$y=t,this.displayPentiamond(e),s}fall(e){return this.canFall(e)?(this.removePentiamond(e),e.s$y=e.g$y+1,this.displayPentiamond(e),!0):!1}isEmpty(){return this.blocks.every(e=>e.every(t=>!t.g$visible))}removeLine(){const e=this.blocks.map(s=>s[q-1].g$shapeInfo).flat().join(),t=kt.find(s=>s.shape.flat().join()==e);for(let s=0;s<G;s++){for(let i=q-2;i>=0;i--)this.blocks[s][i+1].s$property=[this.blocks[s][i].g$kind,...this.blocks[s][i].g$shapeInfo];this.blocks[s][0].s$property=["g",!0,!1]}return t??null}}class $t{next=["L","J","p","q","U","I"];next2;holdKind=null;currentKind=null;prevKind=null;count=0;nextMemory=[];constructor(){this.next2=window.structuredClone(this.next),ye(this.next),ye(this.next2),this.nextMemory=window.structuredClone(this.next)}get g$holdKind(){return this.holdKind}get g$currentKind(){return this.currentKind}get g$next(){return window.structuredClone(this.next)}get g$prevKind(){return this.prevKind}get g$count(){return this.count}get g$nextMemory(){return window.structuredClone(this.nextMemory)}set s$next(e){this.next=window.structuredClone(e),this.next2=[]}forgetPrev(){this.prevKind=null}popNext(){this.next.length==this.next2.length&&(this.next.push(this.next2[this.count%this.next2.length]),this.nextMemory.push(this.next[this.next2.length])),this.currentKind=this.next.shift(),this.count++,this.count%this.next2.length==0&&ye(this.next2)}proceed(){this.prevKind=this.currentKind,this.popNext()}hold(){this.currentKind&&(this.holdKind?[this.holdKind,this.currentKind]=[this.currentKind,this.holdKind]:(this.holdKind=this.currentKind,this.popNext()))}back(){this.prevKind&&(this.count--,this.next.unshift(this.currentKind),this.currentKind=this.prevKind,this.prevKind=null)}}class fe{x;y;kind="g";direction=!0;visible=!1;constructor(e=se,t=ie,s="g",i=!0){this.x=e,this.y=t,this.kind=s,this.direction=i}get g$x(){return this.x}get g$y(){return this.y}get g$kind(){return this.kind}get g$direction(){return this.direction}get g$visible(){return this.visible}get g$copy(){const e=new fe(this.x,this.y,this.kind,this.direction);return e.s$visible=this.visible,e}get g$state(){return[this.x,this.y,this.kind,this.direction]}set s$x(e){if(this.visible)throw new Error("表示中に座標を変更しないでください");this.x=e}set s$y(e){if(this.visible)throw new Error("表示中に座標を変更しないでください");this.y=e}set s$kind(e){console.assert(!this.visible,"表示中に種類を変更しないでください"),this.kind=e}set s$direction(e){if(this.visible)throw new Error("表示中に方向を変更しないでください");this.direction=e}set s$visible(e){this.visible=e}isOnPlayCanvas(){return!(this.x<0||G<=this.x||this.y<0||q<=this.y||!Number.isSafeInteger(this.x)||!Number.isSafeInteger(this.y))}}class X{x;y;kind;direction=0;visible=!1;monoiamonds;constructor(e=se,t=ie,s="g",i=0){this.x=e,this.y=t,this.kind=s,this.direction=i,this.monoiamonds=Array.from({length:5},()=>new fe),this.reload()}get g$x(){return this.x}get g$y(){return this.y}get g$position(){return[this.x,this.y]}get g$kind(){return this.kind}get g$direction(){return this.direction}get g$visible(){return this.visible}get g$monoiamonds(){return this.monoiamonds.map(e=>e.g$copy)}get g$copy(){const e=new X(this.x,this.y,this.kind,this.direction);return e.s$visible=this.visible,e}get g$states(){return this.monoiamonds.map(e=>e.g$state)}set s$x(e){if(this.visible)throw new Error("表示中に座標を変更しないでください");this.x=e,this.reload()}set s$y(e){if(this.visible)throw new Error("表示中に座標を変更しないでください");this.y=e,this.reload()}set s$position([e,t]){if(this.visible)throw new Error("表示中に座標を変更しないでください");this.x=e,this.y=t,this.reload()}set s$kind(e){if(this.visible)throw new Error("表示中に種類を変更しないでください");this.kind=e,this.reload()}set s$direction(e){if(this.visible)throw new Error("表示中に方向を変更しないでください");this.direction=(e%6+6)%6,this.reload()}set s$visible(e){this.visible=e,this.monoiamonds.forEach(t=>{t.s$visible=e})}getPlacementX(e){return this.x+Ge[this.kind][this.direction][e][0]}getPlacementY(e){return this.y+Ge[this.kind][this.direction][e][1]}reload(){if(!this.visible)for(let e=0;e<this.monoiamonds.length;e++)this.monoiamonds[e].s$x=this.getPlacementX(e),this.monoiamonds[e].s$y=this.getPlacementY(e),this.monoiamonds[e].s$kind=this.kind,this.monoiamonds[e].s$direction=(e+this.direction)%2==0}isOnPlayCanvas(){for(let e=0;e<this.monoiamonds.length;e++)if(!this.monoiamonds[e].isOnPlayCanvas())return!1;return!0}}class wt{blockManager=new It;hand=new X;prevPosition=null;prevDirection=null;next=new $t;pausing=!0;lastTrick=null;eventClassNames=["move","move-left","move-right","move-down","spin","spin-left","spin-right","put","unput","removeLine","hold"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(){}get g$graphicData(){return{blockProperties:this.blockManager.g$blockProperties,ghostMondState:this.g$ghostState,next:this.next.g$next,hold:this.next.g$holdKind}}get g$blockManager(){return this.blockManager}get g$nextMemory(){return window.structuredClone(this.next.g$nextMemory)}set s$next(e){this.next.g$currentKind||(this.next.s$next=e)}get g$ghostState(){if(!this.hand.g$visible)return[];this.blockManager.removePentiamond(this.hand);const e=this.hand.g$copy;for(e.s$visible=!1,this.blockManager.displayPentiamond(e);this.blockManager.fall(e););return this.blockManager.removePentiamond(e),this.blockManager.displayPentiamond(this.hand),e.g$states}get g$lastTrick(){return this.lastTrick}start(){this.next.g$currentKind||this.proceed(),this.pausing=!1,this.blockManager.displayPentiamond(this.hand)}stop(){this.pausing=!0,this.blockManager.removePentiamond(this.hand)}proceed(){this.next.proceed(),this.initializeHand(),this.blockManager.displayPentiamond(this.hand)}initializeHand(){this.hand=new X(se,ie,this.next.g$currentKind)}move(e){this.isOperable()&&this.blockManager.move(this.hand,e)&&(h.executeListeningEvents("move",this.eventIds),h.executeListeningEvents("move-"+e,this.eventIds))}spin(e){this.isOperable()&&this.blockManager.spin(this.hand,e)&&(h.executeListeningEvents("spin",this.eventIds),h.executeListeningEvents("spin-"+e,this.eventIds))}hold(){this.isOperable()&&(this.blockManager.removePentiamond(this.hand),this.next.hold(),this.initializeHand(),this.blockManager.displayPentiamond(this.hand),h.executeListeningEvents("hold",this.eventIds))}put(){if(this.isOperable()){for(;this.blockManager.fall(this.hand););this.prevPosition=this.hand.g$position,this.prevDirection=this.hand.g$direction,this.proceed(),h.executeListeningEvents("put",this.eventIds)}}unput(){this.pausing||!this.prevPosition||(this.blockManager.removePentiamond(this.hand),this.next.back(),this.initializeHand(),this.hand.s$position=this.prevPosition,this.hand.s$direction=this.prevDirection,this.hand.s$visible=!0,this.blockManager.removePentiamond(this.hand),this.hand.s$position=[se,ie],this.hand.s$direction=0,this.blockManager.displayPentiamond(this.hand),this.forgetPrev(),h.executeListeningEvents("unput",this.eventIds))}removeLine(){this.pausing||(this.blockManager.removePentiamond(this.hand),this.forgetPrev(),this.lastTrick=this.blockManager.removeLine(),this.hand.s$position=[se,ie],this.hand.s$direction=0,this.blockManager.displayPentiamond(this.hand),h.executeListeningEvents("removeLine",this.eventIds))}forgetPrev(){this.prevPosition=null,this.prevDirection=null,this.next.forgetPrev()}isOperable(){return this.hand.g$visible&&!this.pausing}isPausing(){return this.pausing}}class xt{blockManager;nuisanceMonds=[];penalty=0;damaging=!1;loop=new le;task=0;taskCount=0;progressCount=0;spawnCoordinates=[];spawnCoordinateMemory=[];eventClassNames=["startDamage","progress","destroyMond","damageBoard","finishDamage"];eventIds=[];addEvent(e,t){const s=h.addEvent({classNames:e.filter(i=>this.eventClassNames.includes(i)),handler:t});return this.eventIds.push(s),s}constructor(e){this.blockManager=e,J.push(this.loop.addEvent(["loop"],()=>{this.damageProcess()}))}get g$penalty(){return this.damaging?-1:this.penalty}get g$spawnCoordinateMemory(){return this.spawnCoordinateMemory}set s$spawnCoordinates(e){this.spawnCoordinates=e}get g$progressFrequency(){const e=Math.floor(at/(Ae*(this.task-1)+q));return e<5?5:e}createNuisanceBlock(e,t){const s=new fe(e,t,"g",!1);this.blockManager.canDisplayMonoiamond(s)?(this.blockManager.displayMonoiamond(s),this.nuisanceMonds.push(s)):this.blockManager.getBlockProperty(e,t)[1]?0<e?this.blockManager.remove(e-1,t):e<G-1?this.blockManager.remove(e+1,t):this.blockManager.remove(e,t):this.blockManager.remove(e,t),this.spawnCoordinateMemory.push(e)}damage(e){if(this.damaging&&e>0){this.task+=e,this.loop.reset(),this.loop.s$loopFrequency=this.g$progressFrequency;return}this.damaging=!0,this.penalty=0,this.task=e,this.progressCount=0,this.loop.reset(),this.loop.s$loopFrequency=this.g$progressFrequency,h.executeListeningEvents("startDamage",this.eventIds)}progress(){let e=!1;for(const t of this.nuisanceMonds){e=!1;const s=(r,l)=>this.blockManager.getBlockProperty(t.g$x+r,t.g$y+l)[2],i=(r,l)=>this.blockManager.getBlockProperty(t.g$x+r,t.g$y+l)[1],a=(r,l)=>{(r!=0||l!=0)&&this.blockManager.remove(t.g$x+r,t.g$y+l),this.blockManager.removeMonoiamond(t)},n=()=>t.g$y==q-1;0<t.g$x&&t.g$x<G-1?s(-1,0)?a(-1,0):s(1,0)?a(1,0):n()?(e=!0,a(0,0)):s(0,1)&&!i(0,1)?a(0,1):s(-1,1)&&!i(-1,1)?a(-1,1):s(1,1)&&!i(1,1)?a(1,1):s(0,1)&&a(0,1):0<t.g$x?s(-1,0)?a(-1,0):n()?(e=!0,a(0,0)):s(0,1)&&!i(0,1)?a(0,1):s(-1,1)&&!i(-1,1)?a(-1,1):s(0,1)&&a(0,1):t.g$x<G-1?s(1,0)?a(1,0):n()?(e=!0,a(0,0)):s(0,1)&&!i(0,1)?a(0,1):s(1,1)&&!i(1,1)?a(1,1):s(0,1)&&a(0,1):n()?(e=!0,a(0,0)):s(0,1)&&a(0,1),t.g$visible?(this.blockManager.removeMonoiamond(t),t.s$y=t.g$y+1,this.blockManager.displayMonoiamond(t)):e?(h.executeListeningEvents("damageBoard",this.eventIds),this.penalty++):h.executeListeningEvents("destroyMond",this.eventIds)}this.nuisanceMonds=this.nuisanceMonds.filter(t=>t.g$visible),h.executeListeningEvents("progress",this.eventIds)}damageProcess(){if(this.progressCount==0)if(this.taskCount<this.task){this.progress();const e=this.spawnCoordinates.length?this.spawnCoordinates.shift():Math.floor(Math.random()*G);this.createNuisanceBlock(e,0),this.progressCount++,this.taskCount++}else this.nuisanceMonds.length==0?this.finishDamage():this.progress();else this.nuisanceMonds.length==0?this.progressCount=0:(this.progress(),this.progressCount++),this.progressCount==Ae&&(this.progressCount=0)}finishDamage(){this.loop.reset(),this.task=0,this.progressCount=0,this.taskCount=0,h.executeListeningEvents("finishDamage",this.eventIds),this.damaging=!1}cancelDamage(){this.loop.reset();for(const e of this.nuisanceMonds)this.blockManager.removeMonoiamond(e);this.task=0,this.progressCount=0,this.taskCount=0,this.damaging=!1}stop(){this.damaging&&this.loop.stop()}start(){this.damaging&&this.loop.start()}}class Pt{playCanvas=document.createElement("canvas");pct;nextCanvas=document.createElement("canvas");nct;data={blockProperties:null,ghostMondState:[],next:[],hold:null};guideBorder=!1;guideBorderHeight=15;constructor(){this.playCanvas.classList.add("playCanvas"),this.pct=this.playCanvas.getContext("2d"),this.playCanvas.height=S*(Ee+Le),this.playCanvas.width=K*ke,this.playCanvas.style.aspectRatio=this.playCanvas.width/this.playCanvas.height+"",this.nextCanvas.classList.add("nextCanvas"),this.nct=this.nextCanvas.getContext("2d"),this.nextCanvas.height=S*v.height*(v.scale.hold+v.scale.normal*v.length)+v.gap,this.nextCanvas.width=K*v.width*Math.max(v.scale.hold,v.scale.normal),this.nextCanvas.style.aspectRatio=this.nextCanvas.width/this.nextCanvas.height+""}get g$playCanvas(){return this.playCanvas}get g$nextCanvas(){return this.nextCanvas}readData(e){this.data=e}paint(){this.paintPlayCanvas(),this.paintNextCanvas()}paintPlayCanvas(){this.pct.clearRect(0,0,this.playCanvas.width,this.playCanvas.height),this.paintBackground(),this.guideBorder&&this.paintGuideBorder(),this.paintGrid(),this.paintGhost(),this.paintBlocks()}paintGhost(){this.data.ghostMondState.length!=0&&this.data.ghostMondState.forEach(e=>{this.paintBlock(e[0],e[1],[e[2],e[3],!0],!0)})}paintBlocks(){if(this.data.blockProperties)for(let e=0;e<G;e++)for(let t=0;t<q;t++)this.paintBlock(e,t,this.data.blockProperties[e][t])}paintBlock(e,t,s,i=!1){if(!s[2])return;i?(this.pct.strokeStyle=Q.ghost.color,this.pct.fillStyle=ve.ghost[s[0]],this.pct.lineWidth=Q.ghost.width):(this.pct.strokeStyle=Q.normal.color,this.pct.fillStyle=ve.normal[s[0]],this.pct.lineWidth=Q.normal.width),this.pct.lineJoin="bevel",this.pct.lineCap="round";const a=this.getGraphicPosition(e,t),n=Y([0,s[1]?S:0],a),r=Y([K/2,s[1]?0:S],a),l=Y([K,s[1]?S:0],a);this.pct.beginPath(),this.pct.moveTo(n[0],n[1]),this.pct.lineTo(r[0],r[1]),this.pct.lineTo(l[0],l[1]),this.pct.closePath(),this.pct.fill(),this.pct.stroke()}paintBackground(){this.pct.fillStyle=Me,this.pct.fillRect(0,0,this.playCanvas.width,this.playCanvas.height)}paintGuideBorder(){this.pct.fillStyle=it,this.pct.fillRect(0,S*(Ee+Le-this.guideBorderHeight),this.playCanvas.width,S)}paintGrid(){this.pct.strokeStyle=De.color,this.pct.lineWidth=De.width;for(let e=0;e<=ke;e++)this.pct.beginPath(),this.pct.moveTo(e*K,0),this.pct.lineTo(e*K,this.playCanvas.height),this.pct.stroke()}getGraphicPosition(e,t){return[K*(e/2),this.playCanvas.height-S*(q-t)]}getNextGraphicPosition(e,t,s=!1){return[K*(e/2)*(s?v.scale.hold:v.scale.normal),s?S*v.scale.hold*t:S*v.scale.hold*v.height+v.gap+S*v.scale.normal*(t-v.height)]}paintNextCanvas(){this.nct.clearRect(0,0,this.nextCanvas.width,this.nextCanvas.height),this.paintNextBackground(),this.paintNext()}paintNextBackground(){this.nct.fillStyle=Me,this.nct.fillRect(0,0,K*v.width*v.scale.hold,S*v.height*v.scale.hold+v.gap/4),this.nct.fillRect(0,S*v.height*v.scale.hold+v.gap*3/4,K*v.width*v.scale.normal,S*v.height*v.length+v.gap/4),this.nct.fillStyle=v.splitColor,this.nct.fillRect(0,S*v.height*v.scale.hold+v.gap/4,this.nextCanvas.width,v.gap/2)}paintNext(){const e=v.height/2-Math.floor(v.height/2);this.data.hold&&new X(v.width-1,Math.floor((v.height-1)/2),this.data.hold).g$states.forEach(i=>{this.paintNextBlock(i[0],i[1]+e,[i[2],i[3],!0],!0)});for(let t=0;t<Math.min(v.length,this.data.next.length);t++)new X(v.width-1,Math.floor(v.height/2)+v.height*(t+1),this.data.next[t]).g$states.forEach(a=>{this.paintNextBlock(a[0],a[1]+e,[a[2],a[3],!0])})}paintNextBlock(e,t,s,i=!1){if(!s[2])return;this.nct.strokeStyle=Q.normal.color,this.nct.fillStyle=ve.normal[s[0]],this.nct.lineWidth=Q.normal.width,this.nct.lineJoin="bevel",this.nct.lineCap="round";const a=i?v.scale.hold:v.scale.normal,n=this.getNextGraphicPosition(e,t,i),r=Y([0,s[1]?S*a:0],n),l=Y([K*a/2,s[1]?0:S*a],n),u=Y([K*a,s[1]?S*a:0],n);this.nct.beginPath(),this.nct.moveTo(r[0],r[1]),this.nct.lineTo(l[0],l[1]),this.nct.lineTo(u[0],u[1]),this.nct.closePath(),this.nct.fill(),this.nct.stroke()}}class St{labels={gameTime:{name:"Time",label:document.createElement("div"),content:"",visible:!1},playTime:{name:"Time",label:document.createElement("div"),content:"",visible:!1},line:{name:"Line",label:document.createElement("div"),content:"",visible:!1},lastTrick:{name:"Trick",label:document.createElement("div"),content:"",visible:!1},chain:{name:"Chain",label:document.createElement("div"),content:"",visible:!1},score:{name:"Score",label:document.createElement("div"),content:"",visible:!1}};base=document.createElement("div");constructor({gameTime:e,playTime:t,line:s=!1,lastTrick:i,chain:a,score:n}={gameTime:!1,playTime:!1,line:!1,lastTrick:!1,chain:!1,score:!1}){this.s$visible={gameTime:e,playTime:t,line:s,lastTrick:i,chain:a,score:n},Object.values(this.labels).forEach(r=>{r.label.classList.add("informationLabel"),this.base.appendChild(r.label),r.name=="Trick"?b.g$registeredInputNumber==1?r.label.style.fontSize="3vh":r.label.style.fontSize=`calc((100vh * 14 / 9 / ${b.g$registeredInputNumber}) /33)`:r.name=="Score"?b.g$registeredInputNumber==1?r.label.style.fontSize="4vh":r.label.style.fontSize=`calc((100vh * 14 / 9 / ${b.g$registeredInputNumber}) /28)`:b.g$registeredInputNumber==1?r.label.style.fontSize="6vh":r.label.style.fontSize=`calc((100vh * 14 / 9 / ${b.g$registeredInputNumber}) /17)`}),b.g$registeredInputNumber==1?this.labels.playTime.label.style.fontSize="4vh":this.labels.playTime.label.style.fontSize=`calc((100vh * 14 / 9 / ${b.g$registeredInputNumber}) /28)`,this.base.classList.add("informationLabelBase")}get g$element(){return this.base}set s$visible({gameTime:e,playTime:t,line:s,lastTrick:i,chain:a,score:n}){[this.labels.gameTime.visible,this.labels.playTime.visible,this.labels.line.visible,this.labels.lastTrick.visible,this.labels.chain.visible,this.labels.score.visible]=[e,t,s,i,a,n],this.labels.gameTime.label.style.display=e?"":"none",this.labels.playTime.label.style.display=t?"":"none",this.labels.line.label.style.display=s?"":"none",this.labels.lastTrick.label.style.display=i?"":"none",this.labels.chain.label.style.display=a?"":"none",this.labels.score.label.style.display=n?"":"none"}updateContents({gameTime:e,playTime:t,line:s,lastTrick:i,chain:a,score:n}){e!=null&&this.labels.gameTime.visible&&this.labels.gameTime.content!=e&&(this.labels.gameTime.content=e,this.labels.gameTime.label.innerHTML=`<div class="informationLabelHeader">${this.labels.gameTime.name}</div>`+e),t!=null&&this.labels.playTime.visible&&this.labels.playTime.content!=t&&(this.labels.playTime.content=t,this.labels.playTime.label.innerHTML=`<div class="informationLabelHeader">${this.labels.playTime.name}</div>`+t),s!=null&&this.labels.line.visible&&this.labels.line.content!=s&&(this.labels.line.content=s,this.labels.line.label.innerHTML=`<div class="informationLabelHeader">${this.labels.line.name}</div>`+s),i!=null&&this.labels.lastTrick.visible&&this.labels.lastTrick.content!=i&&(this.labels.lastTrick.content=i,this.labels.lastTrick.label.innerHTML=`<div class="informationLabelHeader">${this.labels.lastTrick.name}</div>`+i),a!=null&&this.labels.chain.visible&&this.labels.chain.content!=a&&(this.labels.chain.content=a,this.labels.chain.label.innerHTML=`<div class="informationLabelHeader">${this.labels.chain.name}</div>`+a),n!=null&&this.labels.score.visible&&this.labels.score.content!=n&&(this.labels.score.content=n,this.labels.score.label.innerHTML=`<div class="informationLabelHeader">${this.labels.score.name}</div>`+n),P(".informationLabelHeader").forEach(r=>{b.g$registeredInputNumber==1?r.style.fontSize="4vh":r.style.fontSize=`calc((100vh * 14 / 9 / ${b.g$registeredInputNumber}) /22)`})}}class Ct{operator=new wt;loop=new le;nuisanceMondManager;canvas=new Pt;label=new St;input;playField=document.createElement("div");playInfo={maxGameTime:300,gameTime:300,playTime:0,line:0,lastTrick:null,trickCount:0,chain:0,maxChain:0,score:0,penalty:0,penaltyTask:0,recovery:0,surplus:0,put:0,hold:0,unput:0,remove:0,handy:1};state={hasFinished:!1,damaging:!1};damageInfo={damageTask:0,temporaryDamageTask:0,attackTask:0,lastDamageTime:0,totalDamage:0,totalAttack:0};animations={put:this.playField.animate([{transform:"translate(0, 0.3vh)"},{transform:""}],{duration:100,direction:"normal",iterations:1,easing:"ease-out"}),removeLineWithTrick:this.playField.animate([{rotate:"0deg"},{rotate:"-0.5deg"},{rotate:"0.5deg",scale:1.02},{rotate:"0deg"}],{duration:100,direction:"normal",iterations:1}),removeLineWithoutTrick:this.playField.animate([{rotate:"0deg"},{rotate:"-0.5deg"},{rotate:"0.5deg"},{rotate:"0deg"}],{duration:70,direction:"normal",iterations:1}),caution:this.playField.animate([{backgroundColor:""},{backgroundColor:"#eeee99"},{backgroundColor:"#eeee99"},{backgroundColor:""}],{duration:1e3,direction:"normal",iterations:1/0}),warning:this.playField.animate([{backgroundColor:""},{backgroundColor:"#ee9999"},{backgroundColor:"#ee9999"},{backgroundColor:""}],{duration:1e3,direction:"normal",iterations:1/0}),damageBoard:this.playField.animate([{transform:"translate(0, 1.4vh)"},{transform:""}],{duration:10,direction:"normal",iterations:1}),timeWarning:this.playField.animate([{transform:"",rotate:"0deg"},{transform:"translate(-0.08vh, 0)",rotate:"-0.2deg"},{transform:"translate(0.08vh, 0)",rotate:"0.2deg"},{rotate:"0deg"}],{duration:200,direction:"normal",iterations:1/0}),finish:this.playField.animate([{opacity:1,rotate:"0deg",scale:1},{opacity:0,rotate:"720deg",scale:0}],{duration:1e3,direction:"normal",fill:"forwards",iterations:1})};runningAnimations=[];constructor(e){this.nuisanceMondManager=new xt(this.operator.blockManager),J.push(this.nuisanceMondManager.addEvent(["finishDamage"],()=>{this.state.damaging=!1,this.damageInfo.damageTask=0,this.operator.forgetPrev(),this.animations.caution.cancel(),this.animations.warning.cancel(),this.proceedTemporaryDamageTask(),this.loop.g$isLooping&&this.operator.start(),this.updateCanvas()}),this.nuisanceMondManager.addEvent(["damageBoard"],()=>{this.playInfo.penalty+=1,this.animations.damageBoard.play()}),this.nuisanceMondManager.addEvent(["progress"],()=>{this.canvas.readData(this.operator.g$graphicData),this.canvas.paintPlayCanvas()}),this.operator.addEvent(["put"],()=>{F.putShake&&this.animations.put.play()})),this.input=e,this.playField.classList.add("playField"),this.playField.appendChild(this.canvas.g$playCanvas),this.playField.appendChild(this.canvas.g$nextCanvas),this.playField.appendChild(this.label.g$element),this.canvas.paint(),Object.values(this.animations).forEach(t=>{t.cancel()}),this.loop.s$loopFrequency=1e3/60}get g$element(){return this.playField}get g$playTimeString(){return(this.loop.g$elapsedTime/1e3).toFixed(2)}start(){this.state.hasFinished||(this.loop.start(),this.state.damaging||this.operator.start(),this.nuisanceMondManager.start(),this.updateCanvas(),this.runningAnimations.forEach(e=>{e.play()}),this.input.g$type=="autoKeyboard"&&this.input.g$manager.start())}stop(){this.loop.stop(),this.operator.stop(),this.nuisanceMondManager.stop(),this.runningAnimations=Object.values(this.animations).filter(e=>{e.playState=="running"}),this.runningAnimations.forEach(e=>{e.pause()}),this.input.g$type=="autoKeyboard"&&this.input.g$manager.stop()}finish(){this.stop(),this.updateGameTime(),this.state.hasFinished=!0,this.animations.timeWarning.cancel()}addDamageTask(e){if(!(this.state.hasFinished||e==0)){if(this.damageInfo.damageTask!=0&&!this.state.damaging){this.damageInfo.damageTask+=e;return}if(this.state.damaging){this.damageInfo.temporaryDamageTask+=e;return}this.damageInfo.lastDamageTime=this.loop.g$elapsedTime,this.damageInfo.damageTask+=e,this.animations.caution.play()}}proceedTemporaryDamageTask(){this.state.damaging||this.state.hasFinished||this.damageInfo.temporaryDamageTask>0&&(this.damageInfo.damageTask+=this.damageInfo.temporaryDamageTask,this.damageInfo.temporaryDamageTask=0,this.damageInfo.lastDamageTime=this.loop.g$elapsedTime,this.animations.caution.play())}damage(){this.state.damaging||this.damageInfo.damageTask==0||this.state.hasFinished||(this.state.damaging=!0,this.operator.stop(),this.nuisanceMondManager.damage(this.damageInfo.damageTask),this.nuisanceMondManager.start())}updateGameTime(){this.state.hasFinished||(this.playInfo.gameTime=Math.max(Math.ceil(this.playInfo.maxGameTime-this.loop.g$elapsedTime/nt)-this.playInfo.penalty+this.playInfo.recovery-this.playInfo.surplus,0),this.playInfo.gameTime>this.playInfo.maxGameTime&&(this.playInfo.surplus+=this.playInfo.gameTime-this.playInfo.maxGameTime,this.playInfo.gameTime=this.playInfo.maxGameTime))}updateCanvas(){this.canvas.readData(this.operator.g$graphicData),this.canvas.paint()}}class ge{players;game;playSetting;replayData;hasStarted=!1;get g$hasStarted(){return this.hasStarted}get g$hasFinished(){return this.game.g$hasFinished}get g$isPlaying(){return this.game.g$isPlaying}onFinished=()=>{};constructor(e,t,s,{playSetting:i,replayData:a}){if(a)this.replayData=a,this.playSetting=a.playSetting;else if(i)this.playSetting=i;else throw new Error("引数不足");this.players=ge.createPlayers(this.playSetting.maxGameTime,t,s,{replayData:this.replayData});const n=e[this.playSetting.mode-1];this.game=new n(this.players),this.game.addEvent(["gameFinish"],async()=>{await this.onGameFinish()})}quit(){this.game.stop(),this.game.remove()}appendPlayersTo(e){this.players.forEach(t=>{e.appendChild(t.g$element)})}isReplay(){return!!this.replayData}async start(){this.game.start(),this.hasStarted=!0}async onGameFinish(){this.isReplay()&&this.onFinishReplay(),await Z(1e3),this.game.remove(),this.onFinished()}onFinishReplay(){const e=this.replayData;if(!e)throw new Error("この関数はリプレイ時のみ実行されるはず");e.finishPlayers.forEach(t=>{const s=this.players[t-1];s.playInfo.playTime=e.finishTime,s.label.updateContents({playTime:(e.finishTime/1e3).toFixed(2)})})}static createPlayers(e,t,s,{replayData:i}){const a=t.map(n=>new Ct(n));return a.forEach((n,r)=>{s==1?(n.g$element.style.flex="none",n.g$element.style.height="100%",n.g$element.style.width=""):(n.g$element.style.flex="",n.g$element.style.height="",n.g$element.style.width="0px"),n.playInfo.maxGameTime=e,n.playInfo.gameTime=e,i&&(n.operator.s$next=i.nextData[r],n.nuisanceMondManager.s$spawnCoordinates=i.nuisanceBlockData[r])}),a}}class _{static parser=new DOMParser;static setEvents(){const e=T("#result .saveReplayButton");p.addEvent(["pageChanged-result"],()=>{e.innerText="リプレイを保存する"})}static setSaveButton(){const e=T("#result .saveReplayButton");e.onclick=async()=>{e.innerText="保存中……",await Z(17),await U.saveLastOne()&&(U.setupSavedReplayPage(),U.updateTempReplaySaveButton(),e.innerText="保存しました",e.onclick=()=>{})}}static OverWriteTime(e){P(".resultLabel").forEach(t=>{t.innerText.includes("Time")&&(t.innerText=`Time : ${(e/1e3).toFixed(2)}`)})}static updateDetailedResultPage({players:e,playSetting:t}){P("#detailedResult .subPage").forEach(a=>{a.remove()});const s=T("#detailedResult .subPageController"),i=this.createResultTitlePage(e,t);s.before(i),e.forEach((a,n)=>{const r=this.createPlayerResultPage(t,a,n);s.before(r)})}static createResultTitlePage(e,t){const s=`
            <div class="subPage">
                <div class="text">
                    Player人数 : ${e.length}<br />
                    モード : ${t.mode==1?"サバイバル":"十五列揃え"}<br />
                    ${e.length!=1?`勝者 : ${T(".resultLabel").innerHTML}<br />`:""}
                </div>
            </div>    
        `;return this.parser.parseFromString(s,"text/html").body.firstElementChild}static createPlayerResultPage(e,t,s){const i=`
            <div class="subPage">
                <div class="text">
                    Player : ${s+1}<br />
                    ${[1].includes(e.mode)?`開始Time : ${t.playInfo.maxGameTime}<br />`:""}
                    ${[1].includes(e.mode)?`残りTime : ${t.playInfo.gameTime}<br />`:""}
                    プレイ時間 : ${(t.playInfo.playTime/1e3).toFixed(2)}<br />
                    役の回数 : ${t.playInfo.trickCount}<br />
                    一列揃え : ${t.playInfo.line}<br />
                    最大Chain : ${t.playInfo.maxChain}<br />
                    Score : ${t.playInfo.score}<br />
                </div>
                <div class="text">
                    ペナルティ : ${t.playInfo.penalty}<br />
                    回復 : ${t.playInfo.recovery}<br />
                    余剰回復 : ${t.playInfo.surplus}<br />
                    設置 : ${t.playInfo.put}<br />
                    ホールド : ${t.playInfo.hold}<br />
                    一手戻し : ${t.playInfo.unput}<br />
                    消去 : ${t.playInfo.remove}<br />
                </div>
                <div class="text">
                    合計ダメージ : ${t.damageInfo.totalDamage}<br />
                    合計攻撃 : ${t.damageInfo.totalAttack}<br />
                    ハンデ : ×${t.playInfo.handy}<br />
                </div>
            </div>
        `;return this.parser.parseFromString(i,"text/html").body.firstElementChild}}function Lt(o){let e=()=>{};const t=()=>{const s=document.createElement("div");s.classList.add("startEffectLabel"),s.innerHTML=o.shift()??"",o.length==0?s.id="startLabel":s.innerHTML!="",T("#startEffectBase").appendChild(s),s.onanimationend=()=>{s.remove(),o.length?t():e()}};return t(),new Promise(s=>{e=s})}class z{static ModeClassList=[ut,dt];static currentGame=null;static resume(){if(!this.currentGame)throw new Error("プレイ中ではない");this.currentGame.game.start()}static isReplaying(){return!!this.currentGame?.isReplay()}static restartNormal(){if(!this.currentGame)throw new Error("一度もプレイされていない");this.startNormal(this.currentGame.playSetting)}static restartReplay(){if(!this.isReplaying())throw new Error("リプレイ中ではない");this.startReplay(this.currentGame.replayData)}static async startNormal(e){this.beforeStart(),this.currentGame=new ge(this.ModeClassList,b.g$registeredInputs,b.g$maxInputNumber,{playSetting:e}),this.currentGame.onFinished=()=>{this.onFinishNormal()},this.currentGame.appendPlayersTo(T("#play")),await this.countDownAndStart()}static async startReplay(e){this.beforeStart(),this.setupReplayInputs(e),this.currentGame=new ge(this.ModeClassList,b.g$registeredInputs,b.g$maxInputNumber,{replayData:e}),this.currentGame.onFinished=()=>{this.onFinishReplay()},this.currentGame.appendPlayersTo(T("#play")),await this.countDownAndStart(),this.startAutoPlay()}static setupReplayInputs(e){b.removeVirtualInputs(),b.resetRegister(),b.s$maxInputNumber=e.playSetting.playerNumber;const t=e.playSetting.playerNumber;for(let s=0;s<t;s++){const i=new Te("autoKeyboard");if(!i.isAuto())throw new Error("あ");i.g$manager.s$inputData=e.inputData[s],b.register(i)}}static startAutoPlay(){b.g$registeredInputs.forEach(e=>{if(!e.isAuto())throw new Error("あ");e.g$manager.playReset(),e.g$manager.playStart()})}static onFinishNormal(){p.setPage("result"),b.removeVirtualInputs(),U.addTempData(this.currentGame),_.setSaveButton(),_.updateDetailedResultPage(this.currentGame)}static onFinishReplay(){p.setPage("replayResult"),b.removeVirtualInputs(),_.OverWriteTime(this.currentGame.replayData.finishTime),_.updateDetailedResultPage(this.currentGame)}static async countDownAndStart(){await Lt(["","3","2","1","START!"]),this.currentGame.start(),p.backPages(1)}static beforeStart(){this.currentGame&&this.currentGame.quit(),oe.reset(),p.setPage("play",{eventIgnore:!0}),p.setPage("startEffect")}}class Mt{focusOnPageChange=!1;mappedElementList=[];updateMappedElementList(e){this.mappedElementList=this.createMappedElements(e)}setupMouseFocusing(){P("[data-mapping]").filter(e=>e instanceof HTMLElement).forEach(e=>{this.setHoverHighlight(e),this.setFocusScroll(e)})}setupRangeFocusing(){P(".rangeContainer[data-mapping]").forEach(e=>{e.querySelectorAll("input").forEach(t=>{t.addEventListener("click",()=>{e.focus()})})})}shiftFocusTo(e){document.activeElement instanceof HTMLElement&&document.activeElement.blur(),this.focusOnPageChange&&(T(`#${e} [data-mapping]`)?.focus(),this.focusOnPageChange=!1)}focusFirstElement(){this.mappedElementList[0]?.element.focus()}getFocusedElement(){return this.mappedElementList.find(({element:e})=>e==document.activeElement)??null}getTargetElement([e,t]){const s=this.getFocusedElement();if(!s)return this.mappedElementList.length>0?this.mappedElementList[0].element:document.body;let[i,a]=s.coordinate,n=Pe(this.mappedElementList.filter(({coordinate:[r,l]})=>r==i+(e??r-i)&&l==a+(t??l-a)).map(({element:r,coordinate:[l,u]})=>({element:r,value:Math.hypot(l-i,u-a)})));return n||(n=Pe(this.mappedElementList.filter(({coordinate:[r,l]})=>r==(e?r:i)&&l==(t?l:a)).map(({element:r,coordinate:[l,u]})=>({element:r,value:(e?0:Math.sign(t??0)*u)+(t?0:Math.sign(e??0)*l)})))),n||(n=s.element),n}setHoverHighlight(e){e.addEventListener("mouseover",()=>{e.focus()}),e.addEventListener("mouseleave",()=>{document.activeElement==e&&e.blur()})}setFocusScroll(e){e.addEventListener("focus",()=>{j.scrollCenter(e)})}createMappedElements(e){return P(`#${e} [data-mapping]`).map(s=>({element:s,coordinate:JSON.parse(s.dataset.mapping)}))}}class Dt{registeredInputList=[];pageOperateEvents=[];onOperate=e=>{};setEvents(){b.addEvent(["inputAdded"],()=>{const e=b.g$inputs.at(-1);e.isAuto()||this.registerInput(e)})}areOperated(e){return this.registeredInputList.some(t=>e.includes(t.g$manager.g$latestPressingKey))}removeInput(){h.removeEvents(this.pageOperateEvents),this.pageOperateEvents=[],this.registeredInputList=[]}registerNonAutoInputs(){b.g$inputs.forEach(e=>{e.isAuto()||this.registerInput(e)})}registerInput(e){if(this.registeredInputList.includes(e))return;this.registeredInputList.push(e);const t=e.g$manager,s=["onKeydown","onButtondown","onStickActive"],i=t.addEvent(s,()=>this.onOperate(t.g$latestPressingKey));this.pageOperateEvents.push(i)}}class Bt{constructor(e){this.view=e}lastOperateTime=0;setEvents(){I("[data-mapping]","click",()=>{this.lastOperateTime=Date.now()})}getLastOperationTime(){return this.lastOperateTime}run(e){if(Date.now()-this.lastOperateTime<=qe)return;if(h.executeEventsByClassName("interaction"),h.executeEventsByClassName(`interaction-${p.g$currentPageId}`),!this.view.getFocusedElement()){this.view.focusFirstElement();return}if(["KeyX","Escape","Backspace","button:0"].includes(e)){this.onCancel();return}this.handleDirectionKey(e),["Enter","Space","KeyZ","button:1"].includes(e)&&this.onOk()}updateLastOperationTimeAndHidePointer(){this.lastOperateTime=Date.now(),$e()}onCancel(){this.view.focusOnPageChange=!0;const e=p.g$currentPage?.querySelector(".back");e&&(this.updateLastOperationTimeAndHidePointer(),h.executeEventsByClassName("cancelInteraction"),h.executeEventsByClassName(`cancelInteraction-${p.g$currentPageId}`),e.click())}onPushDirectionKey(e){const t={up:[null,-1],down:[null,1],right:[1,null],left:[-1,null]},s=this.view.getTargetElement(t[e]);s.focus(),this.updateLastOperationTimeAndHidePointer(),(e==="left"||e==="right")&&this.operateRange(s,e)}operateRange(e,t){if(!e.classList.contains("rangeContainer"))return;const s=e.querySelector("input");t==="left"?s.stepDown():s.stepUp(),s.dispatchEvent(new Event("input"))}onOk(){document.activeElement instanceof HTMLElement&&(this.view.focusOnPageChange=!0,this.view.getFocusedElement().element.click(),this.updateLastOperationTimeAndHidePointer(),h.executeEventsByClassName("confirmInteraction"),h.executeEventsByClassName(`confirmInteraction-${p.g$currentPageId}`))}handleDirectionKey(e){const t=["ArrowUp","KeyW","button:12","stick:-1"],s=["ArrowDown","KeyS","button:13","stick:+1"],i=["ArrowLeft","KeyA","button:14","stick:-0"],a=["ArrowRight","KeyD","button:15","stick:+0"];t.includes(e)&&this.onPushDirectionKey("up"),s.includes(e)&&this.onPushDirectionKey("down"),i.includes(e)&&this.onPushDirectionKey("left"),a.includes(e)&&this.onPushDirectionKey("right")}}class re{static instance;operable=!0;view=new Mt;inputHandler=new Dt;operationRunner=new Bt(this.view);eventClassNames=["interaction","confirmInteraction","cancelInteraction"];addEvent(e,t){return h.addEvent({classNames:e,handler:t})}constructor(){if(re.instance)return re.instance;re.instance=this,this.setEvents()}setHoverHighlight(e){this.view.setHoverHighlight(e)}areOperated(e){return this.inputHandler.areOperated(e)}updateLastOperationTime(){this.operationRunner.updateLastOperationTimeAndHidePointer()}set s$operable(e){this.operable=e}set s$focusFlag(e){this.view.focusOnPageChange=e}get g$lastOperateTime(){return this.operationRunner.getLastOperationTime()}get g$selectedElement(){return this.view.getFocusedElement()}hasSet=!1;setEvents(){if(this.hasSet)throw new Error("既にsetされている!");this.hasSet=!0,p.addEvent(["pageChanged"],()=>{this.updatePageOperateEvent()}),this.operationRunner.setEvents(),this.view.setupMouseFocusing(),this.view.setupRangeFocusing(),this.inputHandler.onOperate=e=>{this.onOperate(e)},this.inputHandler.setEvents()}async updatePageOperateEvent(){const e=p.g$currentPageId;e&&(this.view.shiftFocusTo(e),this.inputHandler.removeInput(),await Z(qe*2.5),this.inputHandler.registerNonAutoInputs(),this.view.updateMappedElementList(e))}onOperate(e){this.operable&&this.operationRunner.run(e)}}const V=new re;V.addEvent(["interaction"],()=>{if(p.g$currentPageId=="play"){const e=["KeyP",...ze[0].pause];if(V.areOperated(e)){const s=z.currentGame;if(!s)throw new Error("ゲームが始められていないのにポーズされた。");z.isReplaying()&&s.g$isPlaying&&(s.game.stop(),V.s$focusFlag=!0,V.updateLastOperationTime(),p.setPage("replayPause"))}return}});class At{static setEvents(){p.addEvent(["setPage-dataSetting"],()=>{const e=this.getAllDataSize();T("#dataInformation").innerHTML=`全データの容量：${e} B`}),p.addEvent(["setPage-allDataDeleteAlert"],async()=>{const e=T("#allDataDeleteConfirmButton");e.disabled=!0,e.style.opacity="0",await Z(1500),e.disabled=!1,e.style.opacity="1"}),I("#allDataDeleteConfirmButton","click",async()=>{this.removeAllData(),p.backPages(2,{eventIgnore:!0}),p.setPage("dataSetting")})}static getAllDataSize(){return new Blob([localStorage.getItem("Pentamond3-replayData")??"",localStorage.getItem("Pentamond3-graphicSetting")??"",localStorage.getItem("Pentamond3-volumeSetting")??""]).size}static removeAllData(){localStorage.removeItem("Pentamond3-replayData"),localStorage.removeItem("Pentamond3-graphicSetting"),localStorage.removeItem("Pentamond3-volumeSetting")}}class Kt{static setEvents(){this.normal(),this.replay()}static normal(){I(".playStart","click",()=>{z.startNormal(we.getPlaySetting())}),I(".restart","click",()=>{p.backLatestPage("playPrepare",{eventIgnore:!0}),z.restartNormal()}),I("#resumeButton","click",()=>{z.resume()})}static replay(){I("#replayPause button:not(#replayResumeButton)","click",()=>{b.removeVirtualInputs()}),I("#replayResumeButton","click",()=>{z.resume()}),I(".replayStart","click",async()=>{p.backPages(2,{eventIgnore:!0}),z.restartReplay()})}}Rt();function Rt(){document.addEventListener("keydown",o=>{["Tab","Space","Enter","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(o.code)&&o.preventDefault()}),P("button").forEach(o=>{o.tabIndex=-1}),P("input").forEach(o=>{o.tabIndex=-1}),P("div[data-mapping]").forEach(o=>{o.tabIndex=0})}I("#pageStart","click",()=>{p.setPage("title")});document.addEventListener("DOMContentLoaded",async()=>{ht(),p.init(),j.init(),b.s$maxInputNumber=1,_.setEvents(),Kt.setEvents(),we.setEvents(),E.setEvents(),F.init(),At.setEvents(),U.setupSavedReplayPage(),console.log(`The sum of size of replayData is ${U.getDataSize()}byte`)});
//# sourceMappingURL=Run.js.map
